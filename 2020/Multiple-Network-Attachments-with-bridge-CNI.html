<!doctype html>
<html lang="en">

  <head>
    <!-- Adding Adobe Analytics -->
    <script id="dpal" src="//www.redhat.com/ma/dpal.js" type="text/javascript"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1, shrink-to-fit=no" >
    <meta name="go-import" content="kubevirt.io/kubevirt git https://github.com/kubevirt/kubevirt">
    <meta name="go-import" content="kubevirt.io/client-go git https://github.com/kubevirt/client-go">
    <meta name="go-import" content="kubevirt.io/containerized-data-importer git https://github.com/kubevirt/containerized-data-importer">
    <meta name="go-import" content="kubevirt.io/hostpath-provisioner git https://github.com/kubevirt/hostpath-provisioner">
    <meta name="go-import" content="kubevirt.io/hostpath-provisioner-operator git https://github.com/kubevirt/hostpath-provisioner-operator">
    <meta name="go-import" content="kubevirt.io/qe-tools git https://github.com/kubevirt/qe-tools">
    <meta name="go-import" content="kubevirt.io/machine-remediation git https://github.com/kubevirt/machine-remediation">
    <meta name="go-import" content="kubevirt.io/cloud-provider-kubevirt git https://github.com/kubevirt/cloud-provider-kubevirt">
    <meta name="go-import" content="kubevirt.io/controller-lifecycle-operator-sdk git https://github.com/kubevirt/controller-lifecycle-operator-sdk">
    <meta name="go-import" content="kubevirt.io/ssp-operator git https://github.com/kubevirt/ssp-operator">
    <meta name="go-import" content="kubevirt.io/cpu-nfd-plugin git https://github.com/kubevirt/cpu-nfd-plugin">
    <meta name="go-import" content="kubevirt.io/containerized-data-importer-api git https://github.com/kubevirt/containerized-data-importer-api">
    <meta name="go-import" content="kubevirt.io/api git https://github.com/kubevirt/api">
    <meta name="go-import" content="kubevirt.io/node-maintenance-operator git https://github.com/kubevirt/node-maintenance-operator">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/favicon/site.webmanifest">
    <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    <meta name="google-site-verification" content="eaETLLM6xObn1li9l9eU8lNIBgBpU0OQLXV1faU1svE" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://kubevirt.io//2020/Multiple-Network-Attachments-with-bridge-CNI.html">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
    
    <title>Multiple Network Attachments with bridge CNI | KubeVirt.io</title>
    <!-- # Opengraph protocol properties: https://ogp.me/ -->
    <meta name="author" content="ellorent" >
    <meta property="og:type" content="article" >
    <meta name="twitter:card" content="summary">
    <meta name="description" content="This post illustrates configuring secondary interfaces at VMs with a L2 linux bridge at nodes using just kube api.">
    <meta name="keywords" content="kubevirt-hyperconverged, cnao, cluster-network-addons-operator, kubernetes-nmstate, nmstate, bridge, multus, networking, CNI, multiple networks" >
    <meta property="og:title" content="Multiple Network Attachments with bridge CNI | KubeVirt.io">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kubevirt.io//2020/Multiple-Network-Attachments-with-bridge-CNI.html" >
    <meta property="og:image" content="https://kubevirt.io//assets/images/KubeVirt_logo_color.png">
    <meta property="og:description" content="This post illustrates configuring secondary interfaces at VMs with a L2 linux bridge at nodes using just kube api." >
    <meta property="og:site_name" content="KubeVirt.io" >
    <meta property="og:article:author" content="ellorent" >
    <meta property="og:article:published_time" content="2020-10-21 00:00:00 +0000" >
    <meta name="twitter:title" content="Multiple Network Attachments with bridge CNI | KubeVirt.io">
    <meta name="twitter:description" content="This post illustrates configuring secondary interfaces at VMs with a L2 linux bridge at nodes using just kube api.">

    <link type="application/atom+xml" rel="alternate" href="https://kubevirt.io//feed.xml" title="KubeVirt.io" />
    <script src="//code.jquery.com/jquery.min.js"></script>
    
    <!-- Photoswipe.com gallery-->

    <!-- Core CSS file -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.css">

    <!-- Skin CSS file (styling of UI - buttons, caption, etc.)
        In the folder of skin CSS file there are also:
        - .png and .svg icons sprite,
        - preloader.gif (for browsers that do not support CSS animations) -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css">
</head>


  <body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" role="navigation">
        <a class="navbar-brand" href="/">
    <img src="/assets/images/KubeVirt_logo_color.svg" class="navbar-brand-image d-inline-block align-top" alt="KubeVirt.io">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <i class="fas fa-th-large"></i>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
      

      
        <li  class="nav-item active" >
          <a class="nav-link text-uppercase" href="/blogs/">Blogs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/videos/">Videos</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/gallery/">Gallery</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="//kubevirt.io/user-guide">Docs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/labs/">Labs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/community/">Community</a>
        </li>
      

      <li class='nav-item'>
        <form action="/search.html" class="nav-item__search" method="get" autocomplete="off">
          <div class="autocomplete" style="width:150px;">
            <input type="text" id="search-input" class="docs-search--input" placeholder="search term" name="query">
          </div>
          <input id="search-button" type="submit" value="🔍" disabled='true'>
        </form>
      </li>

    </ul>
  </div>
<script>
function autocomplete(inp, arr) {
  /*the autocomplete function takes two arguments,
  the text field element and an array of possible autocompleted values:*/
  var currentFocus;
  /*execute a function when someone writes in the text field:*/
  inp.addEventListener("input", function(e) {
      var a, b, i, val = this.value;
      /*close any already open lists of autocompleted values*/
      closeAllLists();
      if (!val) { return false;}
      currentFocus = -1;
      /*create a DIV element that will contain the items (values):*/
      a = document.createElement("DIV");
      a.setAttribute("id", this.id + "autocomplete-list");
      a.setAttribute("class", "autocomplete-items");
      /*append the DIV element as a child of the autocomplete container:*/
      this.parentNode.appendChild(a);
      /*for each item in the array...*/
      for (i = 0; i < arr.length; i++) {
        /*check if the item starts with the same letters as the text field value:*/
        if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
          /*create a DIV element for each matching element:*/
          b = document.createElement("DIV");
          /*make the matching letters bold:*/
          b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
          b.innerHTML += arr[i].substr(val.length);
          /*insert a input field that will hold the current array item's value:*/
          b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
          /*execute a function when someone clicks on the item value (DIV element):*/
              b.addEventListener("click", function(e) {
              /*insert the value for the autocomplete text field:*/
              inp.value = this.getElementsByTagName("input")[0].value;
              /*close the list of autocompleted values,
              (or any other open lists of autocompleted values:*/
              closeAllLists();
          });
          a.appendChild(b);
        }
      }
  });
  /*execute a function presses a key on the keyboard:*/
  inp.addEventListener("keydown", function(e) {
      document.getElementById("search-button").disabled= undefined;
      var x = document.getElementById(this.id + "autocomplete-list");
      if (x) x = x.getElementsByTagName("div");
      if (e.keyCode == 40) {
        /*If the arrow DOWN key is pressed,
        increase the currentFocus variable:*/
        currentFocus++;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 38) { //up
        /*If the arrow UP key is pressed,
        decrease the currentFocus variable:*/
        currentFocus--;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 13) {
        /*If the ENTER key is pressed, prevent the form from being submitted,*/
        if (currentFocus > -1) {
          /*and simulate a click on the "active" item:*/
          if (x) {
            x[currentFocus].click();
            e.preventDefault();
          }
        }
        if (document.getElementById("search-input").value == "") {
          e.preventDefault();
        }
      }
  });
  function addActive(x) {
    /*a function to classify an item as "active":*/
    if (!x) return false;
    /*start by removing the "active" class on all items:*/
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    /*add class "autocomplete-active":*/
    x[currentFocus].classList.add("autocomplete-active");
  }
  function removeActive(x) {
    /*a function to remove the "active" class from all autocomplete items:*/
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }
  function closeAllLists(elmnt) {
    /*close all autocomplete lists in the document,
    except the one passed as an argument:*/
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
      x[i].parentNode.removeChild(x[i]);
    }
  }
}
/*execute a function when someone clicks in the document:*/
document.addEventListener("click", function (e) {
    closeAllLists(e.target);
});
}
</script>

<script>
var mykeywords = ["libvirt", "KubeVirt", "ClearContainers", "virtlet", "CRI", "OpenStack", "ovirt", "release notes", "changelog", "hilights", "network", "flannel", "kubevirt-ansible", "Skydive", "openshift", "glusterfs", "heketi", "virtual machine", "weavenet", "custom resources", "kubevirt objects", "objects", "VirtualMachine", "api", "rbac", "roles", "storage", "ovn", "kubetron", "neutron", "vscode", "development", "debug", "istio", "iptables", "tproxy", "service mesh", "ebtables", "docker", "container", "build", "multus", "roadmap", "kvm", "qemu", "device plugins", "unit testing", "review", "hugepages", "kubevirtci", "ci-cd", "cicd", "memory", "overcommitment", "networking", "CNI", "multiple networks", "ovs-cni", "import", "clone", "upload", "disk image", "cdi", "datavolumes", "volume types", "serviceaccount", "ignition", "coreos", "rhcos", "kubecon", "conference", "gcp", "autodeployer", "metrics", "prometheus", "grafana", "federation", "kubefed", "multicluster", "HCO", "hyperconverged operator", "ansible", "vagrant", "lifecycle", "virtual machines", "website", "community", "vm import", "node drain", "eviction", "nmo", "condition types", "Condition types", "CNCF", "sandbox", "lab", "cri-o", "quickstart", "homelab", "kubernetes", "kubevirt installation", "rook", "ceph", "ntp", "chronyd", "prow", "infrastructure", "kubevirt-tutorial", "CI-CD", "continuous integration", "jenkins", "noVNC", "console", "KubeCon", "cloudnativecon", "America", "talk", "gathering", "contra-lib", "admin", "operations", "create vm", "start vm", "connect to console", "connect to ssh", "stop vm", "remove vm", "operator manual", "basic operations", "laboratory", "installing kubevirt", "use kubevirt", "admin operations", "CDI", "containerized data importer", "octant", "okd", "openshift console", "cockpit", "user interface", "web interface", "virtVNC", "OKD console", "kubevirt upgrade", "upgrading", "OpenShift web console", "OKD", "video", "virtual machine management", "NUMA", "CPU pinning", "QEMU", "KVM", "GPU", "NVIDIA", "GPU workloads", "pass-through", "passthrough", "kubevirt", "Microsoft Windows kubernetes", "Microsoft Windows container", "Windows", "VM", "Advanced VM scheduling", "affinity", "scheduling", "topologyKeys", "Live Migration", "design", "architecture", "security", "operation", "images", "Kubernetes", "windows", "common-templates", "minikube", "addons", "oVirt", "kubevirt-hyperconverged", "cnao", "cluster-network-addons-operator", "kubernetes-nmstate", "nmstate", "bridge", "containerDisk", "registry", "composer-cli", "virt-customize", "builder tool", "prometheus-operator", "node-exporter", "monitoring", "event", "Tekton Pipelines", "KubeVirt Tekton Tasks", "vGPU", "Intel", "Fedora", "go", "authentication", "mesh", "AWS", "EC2", "AMI", "real-time", "CPUManager", "live migration", "dedicated network", "Kubevirt", "load-balancer", "MetalLB", "instancetypes", "preferences", "VirtualMachineInstancetype", "VirtualMachinePreference", ]
autocomplete(document.getElementById("search-input"), mykeywords);
</script>

<script src="/js/clipboard.min.js"></script>

    </nav>

    <main role="main" style="margin-top: 60px;">
      <div class="container">
  <div class="row">
    <div class="col">
      <div class="post">
        <header class="post-header">
          <h1></h1>
          <h1 class="post-title">Multiple Network Attachments with bridge CNI</h1>
          <div class="post-info">
            <span class="post-author">Author: ellorent</span>
            <div>
              <span class="post-category-name">
                Tags: <a href="/tag/kubevirt-hyperconverged">kubevirt-hyperconverged</a>&nbsp;|&nbsp;<a href="/tag/cnao">cnao</a>&nbsp;|&nbsp;<a href="/tag/cluster-network-addons-operator">cluster-network-addons-operator</a>&nbsp;|&nbsp;<a href="/tag/kubernetes-nmstate">kubernetes-nmstate</a>&nbsp;|&nbsp;<a href="/tag/nmstate">nmstate</a>&nbsp;|&nbsp;<a href="/tag/bridge">bridge</a>&nbsp;|&nbsp;<a href="/tag/multus">multus</a>&nbsp;|&nbsp;<a href="/tag/networking">networking</a>&nbsp;|&nbsp;<a href="/tag/cni">CNI</a>&nbsp;|&nbsp;<a href="/tag/multiple-networks">multiple networks</a>
              </span>
            </div>
            <div>
              <span class="post-meta">Publication Date: October 21, 2020  </span>
            </div>
            <div>
              <span class="post-category-name">
                Category: news
              </span>
            </div>

          </div>
        </header>
        <article class="post-content">
          <h2 id="introduction">Introduction</h2>

<p>Over the last years the KubeVirt project has improved a lot regarding secondary interfaces networking configuration. Now it’s possible to do an end to end configuration from host networking to a VM using just the Kubernetes API with
special Custom Resource Definitions. Moreover, the deployment of all the projects has been simplified by introducing <a href="https://github.com/kubevirt/hyperconverged-cluster-operator">KubeVirt hyperconverged cluster operator (HCO)</a> and <a href="https://github.com/kubevirt/cluster-network-addons-operator">cluster network addons operator (CNAO)</a> to install the networking components.</p>

<p>The following is the operator hierarchy list presenting the deployment responsibilities of the HCO and CNAO operators used in this blog post:</p>

<ul>
  <li>kubevirt-hyperconverged-cluster-operator (HCO)
    <ul>
      <li>cluster-network-addons-operator (CNAO)
        <ul>
          <li>multus</li>
          <li>bridge-cni</li>
          <li>kubemacpool</li>
          <li>kubernetes-nmstate</li>
        </ul>
      </li>
      <li>KubeVirt</li>
    </ul>
  </li>
</ul>

<h2 id="introducing-cluster-network-addons-operator">Introducing cluster-network-addons-operator</h2>

<p>The <a href="https://github.com/kubevirt/cluster-network-addons-operator">cluster network addons operator</a> manages the lifecycle (deploy/update/delete) of different Kubernetes network components needed to
configure secondary interfaces, manage MAC addresses and defines networking on hosts for pods and VMs.</p>

<p>A Good thing about having an operator is that everything is done through the API and you don’t have to go over all nodes to install these components yourself and assures smooth updates.</p>

<p>In this blog post we are going to use the following components, explained in a greater detail later on:</p>

<ul>
  <li>multus: to start a secondary interface on containers in pods</li>
  <li>linux bridge CNI: to use bridge CNI and connect the secondary interfaces from pods to a linux bridge at nodes</li>
  <li>kubemacpool: to manage mac addresses</li>
  <li>kubernetes-nmstate: to configure the linux bridge on the nodes</li>
</ul>

<p>The list of components we want CNAO to deploy is specified by the <code class="language-plaintext highlighter-rouge">NetworkAddonsConfig</code> Custom Resource (CR) and the progress of the installation appears in the CR status field, split per component. To inspect
this progress we can query the CR status with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get NetworkAddonsConfig cluster <span class="nt">-o</span> yaml
</code></pre></div></div>

<p>To simplify this blog post we are going to use directly the NetworkAddonsConfig from HCO, which by default installs all the network components, but just to illustrate CNAO configuration, the following is a NetworkAddonsConfig CR instructing to deploy multus, linuxBridge, nmstate and kubemacpool components:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networkaddonsoperator.network.kubevirt.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkAddonsConfig</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cluster</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">multus</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">linuxBridge</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">nmstate</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Always</span>
</code></pre></div></div>

<h2 id="connecting-pods-vms-and-nodes-over-a-single-secondary-network-with-bridge-cni">Connecting Pods, VMs and Nodes over a single secondary network with bridge CNI</h2>

<p>Although Kubernetes provides a default interface that gives connectivity to pods and VMs, it’s not easy to configure which NIC should be used for specific pods or VMs in a multi NIC node cluster. A Typical use case is to split control/traffic planes isolated by different NICs on nodes.</p>

<p>With linux bridge CNI + multus it’s possible to create a secondary NIC in pod containers and attach it to a L2 linux bridge on nodes. This will add container’s connectivity to a specific NIC on nodes if that NIC is part of the L2 linux bridge.</p>

<p>To ensure the configuration is applied only in pods on nodes that have the bridge, the <code class="language-plaintext highlighter-rouge">k8s.v1.cni.cncf.io/resourceName</code> label is added. This goes hand in hand with another component, <a href="https://github.com/kubevirt/bridge-marker">bridge-marker</a> which inspects nodes networking and if a new bridge pops up it will mark the node status with it.</p>

<p>This is an example of the results from bridge-marker on nodes where bridge br0 is already configured:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">status</span><span class="pi">:</span>
  <span class="na">allocatable</span><span class="pi">:</span>
    <span class="na">bridge.network.kubevirt.io/br0</span><span class="pi">:</span> <span class="s">1k</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">bridge.network.kubevirt.io/br0</span><span class="pi">:</span> <span class="s">1k</span>
</code></pre></div></div>

<p>This is an example of <code class="language-plaintext highlighter-rouge">NetworkAttachmentDefinition</code> to expose the bridge available on the host to users:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">k8s.cni.cncf.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkAttachmentDefinition</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">bridge-network</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">k8s.v1.cni.cncf.io/resourceName</span><span class="pi">:</span> <span class="s">bridge.network.kubevirt.io/br0</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">{</span>
        <span class="s">"cniVersion": "0.3.1",</span>
        <span class="s">"name": "br0-l2",</span>
        <span class="s">"plugins": [{</span>
            <span class="s">"type": "bridge",</span>
            <span class="s">"bridge": "br0",</span>
            <span class="s">"ipam": {}</span>
        <span class="s">}]</span>
    <span class="s">}</span>
</code></pre></div></div>

<p>Then adding the bridge secondary network to a pod is a matter of adding the following annotation to
it:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">annotations</span><span class="pi">:</span>
  <span class="na">k8s.v1.cni.cncf.io/networks</span><span class="pi">:</span> <span class="s">bridge-network</span>
</code></pre></div></div>

<h2 id="setting-up-node-networking-with-nodenetworkconfigurationpolicy-aka-nncp">Setting up node networking with NodeNetworkConfigurationPolicy (aka nncp)</h2>

<p>Changing Kubernetes cluster node networking can be done manually iterating over all the cluster nodes and making changes or using different automatization tools like ansible. However, using just another Kubernetes resource is more convenient.
For this purpose the kubernetes-nmstate project was born as a cluster wide node network administrator based on Kubernetes CRs on top of <a href="https://github.com/nmstate/nmstate">nmstate</a>.</p>

<p>It works as a Kubernetes <code class="language-plaintext highlighter-rouge">DaemonSet</code> running pods on all the cluster nodes and reconciling three different CRs:</p>

<ul>
  <li><a href="https://raw.githubusercontent.com/nmstate/kubernetes-nmstate/main/deploy/crds/nmstate.io_v1_nodenetworkconfigurationpolicy_cr.yaml">NodeNetworkConfigurationPolicy</a> to specify cluster node network desired configuration</li>
  <li><a href="https://raw.githubusercontent.com/nmstate/kubernetes-nmstate/main/deploy/crds/nmstate.io_v1beta1_nodenetworkconfigurationenactment_cr.yaml">NodeNetworkConfigurationEnactment</a> (nnce) to troubleshoot issues with nncp</li>
  <li><a href="https://raw.githubusercontent.com/nmstate/kubernetes-nmstate/main/deploy/crds/nmstate.io_v1beta1_nodenetworkstate_cr.yaml">NodeNetworkState</a> (nns) to view the node’s networking configuration</li>
</ul>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>Project kubernetes-nmstate has a distributed architecture to reduce kube-apiserver connectivity dependency, this means that every pod will configure the networking on the node that it’s running without much interaction with kube-apiserver.</p>


</div></div>
<p>In case something goes wrong and the pod changing the node network cannot ping the default gateway, resolve DNS root servers or has lost the kube-apiserver connectivity it will rollback to the previous configuration to go back to a working state. Those errors can be checked by running <code class="language-plaintext highlighter-rouge">kubectl get nnce</code>. The command displays potential issues per node and nncp.</p>

<p>The desired state fields follow the nmstate API described at their <a href="https://www.nmstate.io/">awesome doc</a></p>

<p>Also for more details on kubernetes-nmstate there are guides covering <a href="https://github.com/nmstate/kubernetes-nmstate/blob/master/docs/user-guide/101-reporting.md">reporting</a>, <a href="https://github.com/nmstate/kubernetes-nmstate/blob/master/docs/user-guide/102-configuration.md">configuration</a> and <a href="https://github.com/nmstate/kubernetes-nmstate/blob/master/docs/user-guide/103-troubleshooting.md">troubleshooting</a>. There are also <a href="https://github.com/nmstate/kubernetes-nmstate/tree/master/docs/examples">nncp examples</a>.</p>

<h2 id="demo-mixing-it-all-together-vm-to-vm-communication-between-nodes">Demo: mixing it all together, VM to VM communication between nodes</h2>

<p>With the following recipe we will end up with a pair of virtual machines pair on two different nodes with one secondary NICs, eth1 at vlan 100. They will be connected to each other using
the same bridge on nodes that also have the external secondary NIC eth1 connected.</p>

<h3 id="demo-environment-setup">Demo environment setup</h3>

<p>We are going to use a <a href="https://github.com/kubevirt/kubevirtci">kubevirtci</a> as Kubernetes ephemeral cluster provider.</p>

<p>To start it up with two nodes and one secondary NIC and install NetworkManager &gt;= 1.22 (needed for kubernetes-nmstate) and dnsmasq follow these steps:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/kubevirt/kubevirtci
<span class="nb">cd </span>kubevirtci
<span class="c"># Pin to version working with blog post steps in case</span>
<span class="c"># k8s-1.19 provider disappear in the future</span>
git reset d5d8e3e376b4c3b45824fbfe320b4c5175b37171 <span class="nt">--hard</span>
<span class="nb">export </span><span class="nv">KUBEVIRT_PROVIDER</span><span class="o">=</span>k8s-1.19
<span class="nb">export </span><span class="nv">KUBEVIRT_NUM_NODES</span><span class="o">=</span>2
<span class="nb">export </span><span class="nv">KUBEVIRT_NUM_SECONDARY_NICS</span><span class="o">=</span>1
make cluster-up
<span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="si">$(</span>./cluster-up/kubeconfig.sh<span class="si">)</span>
</code></pre></div></div>

<h3 id="installing-components">Installing components</h3>

<p>To install KubeVirt we are going to use the operator <a href="https://github.com/kubevirt/hyperconverged-cluster-operator">kubevirt-hyper-converged-operator</a>, this will install all the components
needed to have a functional KubeVirt with all the features including the ones we are going to use: multus, linux-bridge, kubemacpool and kubernetes-nmstate.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://raw.githubusercontent.com/kubevirt/hyperconverged-cluster-operator/master/deploy/deploy.sh | bash
kubectl <span class="nb">wait </span>hco <span class="nt">-n</span> kubevirt-hyperconverged kubevirt-hyperconverged <span class="nt">--for</span> <span class="nv">condition</span><span class="o">=</span>Available <span class="nt">--timeout</span><span class="o">=</span>500s
</code></pre></div></div>

<p>Now we have a Kubernetes cluster with all the pieces to startup a VM with bridge attached to a secondary NIC.</p>

<h3 id="creating-the-br0-on-nodes-with-a-port-attached-to-secondary-nic-eth1">Creating the br0 on nodes with a port attached to secondary NIC eth1</h3>

<p>First step is to create a L2 linux-bridge at nodes with one port on the secondary NIC eth1, this will be
used later on by the bridge CNI.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">cat &lt;&lt;EOF | kubectl apply -f -</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">nmstate.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NodeNetworkConfigurationPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">br0-eth1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">desiredState</span><span class="pi">:</span>
    <span class="na">interfaces</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">br0</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s">Linux bridge with eth1 as a port</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">linux-bridge</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">up</span>
      <span class="na">bridge</span><span class="pi">:</span>
        <span class="na">options</span><span class="pi">:</span>
          <span class="na">stp</span><span class="pi">:</span>
            <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">port</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">eth1</span>
<span class="s">EOF</span>
</code></pre></div></div>

<p>Now we wait for the bridge to be created checking nncp conditions:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">wait </span>nncp br0-eth1 <span class="nt">--for</span> <span class="nv">condition</span><span class="o">=</span>Available <span class="nt">--timeout</span> 2m
</code></pre></div></div>

<p>After the nncp becomes available, we can query the nncp resources in the cluster
and see it listed with successful status.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nncp
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME       STATUS
br0-eth1   SuccessfullyConfigured
</code></pre></div></div>

<p>We can inspect the status of applying the policy to each node.
For that there is the <code class="language-plaintext highlighter-rouge">NodeNetworkConfigurationEnactment</code> CR (nnce):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nnce
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME              STATUS
node01.br0-eth1   SuccessfullyConfigured
node02.br0-eth1   SuccessfullyConfigured
</code></pre></div></div>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>In case of errors it is possible to retrieve the error dumped by nmstate running
<code class="language-plaintext highlighter-rouge">kubectl get nnce -o yaml</code> the status will contain the error.</p>


</div></div>
<p>We can also inspect the network state on the nodes by retrieving the <code class="language-plaintext highlighter-rouge">NodeNetworkState</code> and
checking if the bridge <code class="language-plaintext highlighter-rouge">br0</code> is up using jsonpath</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nns node01 <span class="nt">-o</span><span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.currentState.interfaces[?(@.name=="br0")].state}'</span>
kubectl get nns node02 <span class="nt">-o</span><span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.currentState.interfaces[?(@.name=="br0")].state}'</span>
</code></pre></div></div>

<p>When inspecting the full currentState yaml we get the following
interface configuration:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nns node01 <span class="nt">-o</span> yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">status</span><span class="pi">:</span>
  <span class="na">currentState</span><span class="pi">:</span>
    <span class="na">interfaces</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">bridge</span><span class="pi">:</span>
          <span class="na">options</span><span class="pi">:</span>
            <span class="na">group-forward-mask</span><span class="pi">:</span> <span class="m">0</span>
            <span class="na">mac-ageing-time</span><span class="pi">:</span> <span class="m">300</span>
            <span class="na">multicast-snooping</span><span class="pi">:</span> <span class="no">true</span>
            <span class="na">stp</span><span class="pi">:</span>
              <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>
              <span class="na">forward-delay</span><span class="pi">:</span> <span class="m">15</span>
              <span class="na">hello-time</span><span class="pi">:</span> <span class="m">2</span>
              <span class="na">max-age</span><span class="pi">:</span> <span class="m">20</span>
              <span class="na">priority</span><span class="pi">:</span> <span class="m">32768</span>
          <span class="na">port</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">eth1</span>
              <span class="na">stp-hairpin-mode</span><span class="pi">:</span> <span class="no">false</span>
              <span class="na">stp-path-cost</span><span class="pi">:</span> <span class="m">100</span>
              <span class="na">stp-priority</span><span class="pi">:</span> <span class="m">32</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Linux bridge with eth1 as a port</span>
        <span class="na">ipv4</span><span class="pi">:</span>
          <span class="na">dhcp</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">ipv6</span><span class="pi">:</span>
          <span class="na">autoconf</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">dhcp</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">mac-address</span><span class="pi">:</span> <span class="s">52:55:00:D1:56:00</span>
        <span class="na">mtu</span><span class="pi">:</span> <span class="m">1500</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">br0</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">up</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">linux-bridge</span>
</code></pre></div></div>

<p>We can also check that the <code class="language-plaintext highlighter-rouge">bridge-marker</code> is working and check verify on nodes:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get node node01 <span class="nt">-o</span> yaml
</code></pre></div></div>

<p>The following should appear stating that br0
can be consumed on the node:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">status</span><span class="pi">:</span>
  <span class="na">allocatable</span><span class="pi">:</span>
    <span class="na">bridge.network.kubevirt.io/br0</span><span class="pi">:</span> <span class="s">1k</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">bridge.network.kubevirt.io/br0</span><span class="pi">:</span> <span class="s">1k</span>
</code></pre></div></div>

<p>At this point we have an L2 linux bridge ready and connected to NIC eth1.</p>

<h3 id="configure-network-attachment-with-a-l2-bridge-and-a-vlan">Configure network attachment with a L2 bridge and a vlan</h3>

<p>In order to make the bridge a L2 bridge, we specify no IPAM (IP Address Management) since we are
not going to configure any ip address for the bridge. To configure
bridge vlan-filtering we add the vlan we want to use to isolate our VMs:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">cat &lt;&lt;EOF | kubectl apply -f -</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">k8s.cni.cncf.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkAttachmentDefinition</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">br0-100-l2</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">k8s.v1.cni.cncf.io/resourceName</span><span class="pi">:</span> <span class="s">bridge.network.kubevirt.io/br0</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">{</span>
        <span class="s">"cniVersion": "0.3.1",</span>
        <span class="s">"name": "br0-100-l2-config",</span>
        <span class="s">"plugins": [</span>
            <span class="s">{</span>
                <span class="s">"type": "bridge",</span>
                <span class="s">"bridge": "br0",</span>
                <span class="s">"vlan": 100,</span>
                <span class="s">"ipam": {}</span>
            <span class="s">},</span>
            <span class="s">{</span>
                <span class="s">"type": "tuning"</span>
            <span class="s">}</span>
        <span class="s">]</span>
    <span class="s">}</span>
<span class="s">EOF</span>
</code></pre></div></div>

<h3 id="start-a-pair-of-vms-on-different-nodes-using-the-multus-configuration-to-connect-a-secondary-interfaces-to-br0">Start a pair of VMs on different nodes using the multus configuration to connect a secondary interfaces to br0</h3>

<p>Now it’s time to startup the VMs running on different nodes so we can check external connectivity of
br0. They will also have a secondary NIC eth1 to connect to the other VM running at different node, so they go
over the br0 at nodes.</p>

<p>The following picture illustrates the cluster:</p>

<!-- yaspeller ignore:start -->

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="292pt" height="287pt" viewBox="0.00 0.00 292.00 286.51">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 282.5052)">
<title>bridge</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-282.5052 288,-282.5052 288,4 -4,4" />
<g id="clust1" class="cluster">
<title>cluster_kubevirtci</title>
<polygon fill="#3cb371" stroke="#3cb371" points="8,-8 8,-270.5052 276,-270.5052 276,-8 8,-8" />
<text text-anchor="middle" x="142" y="-253.9052" font-family="Times,serif" font-size="14.00" fill="#000000">kubevirtci cluster</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_node01</title>
<polygon fill="#8b864e" stroke="#8b864e" points="146,-72 146,-237.7052 268,-237.7052 268,-72 146,-72" />
<text text-anchor="middle" x="207" y="-221.1052" font-family="Times,serif" font-size="14.00" fill="#000000">node01</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_vma</title>
<polygon fill="#b4cdcd" stroke="#b4cdcd" points="204,-80 204,-160.9052 260,-160.9052 260,-80 204,-80" />
<text text-anchor="middle" x="232" y="-144.3052" font-family="Times,serif" font-size="14.00" fill="#000000">vma</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_node02</title>
<polygon fill="#8b864e" stroke="#8b864e" points="16,-72 16,-237.7052 138,-237.7052 138,-72 16,-72" />
<text text-anchor="middle" x="77" y="-221.1052" font-family="Times,serif" font-size="14.00" fill="#000000">node02</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_vmb</title>
<polygon fill="#b4cdcd" stroke="#b4cdcd" points="74,-80 74,-160.9052 130,-160.9052 130,-80 74,-80" />
<text text-anchor="middle" x="102" y="-144.3052" font-family="Times,serif" font-size="14.00" fill="#000000">vmb</text>
</g>
<!-- nd_br1_kubevirtci -->
<g id="node1" class="node">
<title>nd_br1_kubevirtci</title>
<polygon fill="#ffd700" stroke="#ffd700" points="127,-52 91,-52 91,-16 127,-16 127,-52" />
<text text-anchor="middle" x="109" y="-29.8" font-family="Times,serif" font-size="14.00" fill="#000000">br1</text>
</g>
<!-- nd_br0_node01 -->
<g id="node2" class="node">
<title>nd_br0_node01</title>
<polygon fill="#ffd700" stroke="#ffd700" points="221,-204.9052 185,-204.9052 185,-168.9052 221,-168.9052 221,-204.9052" />
<text text-anchor="middle" x="203" y="-182.7052" font-family="Times,serif" font-size="14.00" fill="#000000">br0</text>
</g>
<!-- nd_eth1_node01 -->
<g id="node3" class="node">
<title>nd_eth1_node01</title>
<polygon fill="#ffd700" stroke="#ffd700" points="194.1053,-128.1579 153.8947,-128.1579 153.8947,-87.9473 194.1053,-87.9473 194.1053,-128.1579" />
<text text-anchor="middle" x="174" y="-103.8526" font-family="Times,serif" font-size="14.00" fill="#000000">eth1</text>
</g>
<!-- nd_br0_node01&#45;&#45;nd_eth1_node01 -->
<g id="edge3" class="edge">
<title>nd_br0_node01--nd_eth1_node01</title>
<path fill="none" stroke="#000000" d="M196.2739,-168.6166C191.8232,-156.5147 185.985,-140.6405 181.4024,-128.18" />
</g>
<!-- nd_eth1_vma -->
<g id="node4" class="node">
<title>nd_eth1_vma</title>
<polygon fill="#ffd700" stroke="#ffd700" points="252.1053,-128.1579 211.8947,-128.1579 211.8947,-87.9473 252.1053,-87.9473 252.1053,-128.1579" />
<text text-anchor="middle" x="232" y="-103.8526" font-family="Times,serif" font-size="14.00" fill="#000000">eth1</text>
</g>
<!-- nd_br0_node01&#45;&#45;nd_eth1_vma -->
<g id="edge4" class="edge">
<title>nd_br0_node01--nd_eth1_vma</title>
<path fill="none" stroke="#000000" d="M209.7261,-168.6166C214.1768,-156.5147 220.015,-140.6405 224.5976,-128.18" />
</g>
<!-- nd_eth1_node01&#45;&#45;nd_br1_kubevirtci -->
<g id="edge1" class="edge">
<title>nd_eth1_node01--nd_br1_kubevirtci</title>
<path fill="none" stroke="#000000" d="M156.2385,-87.8174C146.4655,-76.6833 134.4366,-62.9792 124.9632,-52.1864" />
</g>
<!-- nd_br0_node02 -->
<g id="node5" class="node">
<title>nd_br0_node02</title>
<polygon fill="#ffd700" stroke="#ffd700" points="91,-204.9052 55,-204.9052 55,-168.9052 91,-168.9052 91,-204.9052" />
<text text-anchor="middle" x="73" y="-182.7052" font-family="Times,serif" font-size="14.00" fill="#000000">br0</text>
</g>
<!-- nd_eth1_node02 -->
<g id="node6" class="node">
<title>nd_eth1_node02</title>
<polygon fill="#ffd700" stroke="#ffd700" points="64.1053,-128.1579 23.8947,-128.1579 23.8947,-87.9473 64.1053,-87.9473 64.1053,-128.1579" />
<text text-anchor="middle" x="44" y="-103.8526" font-family="Times,serif" font-size="14.00" fill="#000000">eth1</text>
</g>
<!-- nd_br0_node02&#45;&#45;nd_eth1_node02 -->
<g id="edge5" class="edge">
<title>nd_br0_node02--nd_eth1_node02</title>
<path fill="none" stroke="#000000" d="M66.2739,-168.6166C61.8232,-156.5147 55.985,-140.6405 51.4024,-128.18" />
</g>
<!-- nd_eth1_vmb -->
<g id="node7" class="node">
<title>nd_eth1_vmb</title>
<polygon fill="#ffd700" stroke="#ffd700" points="122.1053,-128.1579 81.8947,-128.1579 81.8947,-87.9473 122.1053,-87.9473 122.1053,-128.1579" />
<text text-anchor="middle" x="102" y="-103.8526" font-family="Times,serif" font-size="14.00" fill="#000000">eth1</text>
</g>
<!-- nd_br0_node02&#45;&#45;nd_eth1_vmb -->
<g id="edge6" class="edge">
<title>nd_br0_node02--nd_eth1_vmb</title>
<path fill="none" stroke="#000000" d="M79.7261,-168.6166C84.1768,-156.5147 90.015,-140.6405 94.5976,-128.18" />
</g>
<!-- nd_eth1_node02&#45;&#45;nd_br1_kubevirtci -->
<g id="edge2" class="edge">
<title>nd_eth1_node02--nd_br1_kubevirtci</title>
<path fill="none" stroke="#000000" d="M61.7615,-87.8174C71.5345,-76.6833 83.5634,-62.9792 93.0368,-52.1864" />
</g>
</g>
</svg>

<!-- NOTE: When gnudot is at production use proper liquid tags to use this code -->
<!--
graph bridge {
node [shape=square, style=filled color=gold];
splines=line;
subgraph cluster_kubevirtci {
label = "kubevirtci cluster";
color = mediumseagreen;
style = filled;
nd_br1_kubevirtci [label = "br1"]
subgraph cluster_node01 {
label = "node01";
color = khaki4;
style=filled;
nd_br0_node01 [label = "br0"]
nd_eth1_node01 [label = "eth1"]
subgraph cluster_vma {
label = "vma";
style=filled;
color=lightcyan3;
nd_eth1_vma [label = "eth1"];
}

    }
    subgraph cluster_node02 {
      label = "node02";
      color = khaki4;
      style = filled;
      nd_br0_node02 [label = "br0"]
      nd_eth1_node02 [label = "eth1"]
      subgraph cluster_vmb {
        label = "vmb";
        style=filled;
        color=lightcyan3;
        nd_eth1_vmb [label = "eth1"];
      }

    }
    nd_eth1_node01 -- nd_br1_kubevirtci
    nd_eth1_node02 -- nd_br1_kubevirtci
    nd_br0_node01 -- nd_eth1_node01
    nd_br0_node01 -- nd_eth1_vma
    nd_br0_node02 -- nd_eth1_node02
    nd_br0_node02 -- nd_eth1_vmb

}
}
-->

<!-- yaspeller ignore:end -->

<p>First step is to install the <code class="language-plaintext highlighter-rouge">virtctl</code> command line tool to play with virtual machines:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> <span class="nt">-o</span> virtctl https://github.com/kubevirt/kubevirt/releases/download/v0.33.0/virtctl-v0.33.0-linux-amd64
<span class="nb">chmod</span> +x virtctl
<span class="nb">sudo install </span>virtctl /usr/local/bin
</code></pre></div></div>

<p>Now let’s create two <code class="language-plaintext highlighter-rouge">VirtualMachine</code>s on each node. They will have one secondary NIC connected to br0 using the multus configuration for vlan 100. We will also activate kubemacpool to be sure that mac addresses are unique in the cluster and install the qemu-guest-agent so IP addresses from secondary NICs are reported to VM and we can inspect them later on.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">cat &lt;&lt;EOF | kubectl apply -f -</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">mutatevirtualmachines.kubemacpool.io</span><span class="pi">:</span> <span class="s">allocate</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubevirt.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualMachine</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vma</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">running</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/hostname</span><span class="pi">:</span> <span class="s">node01</span>
      <span class="na">domain</span><span class="pi">:</span>
        <span class="na">devices</span><span class="pi">:</span>
          <span class="na">disks</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">containerdisk</span>
              <span class="na">disk</span><span class="pi">:</span>
                <span class="na">bus</span><span class="pi">:</span> <span class="s">virtio</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cloudinitdisk</span>
              <span class="na">disk</span><span class="pi">:</span>
                <span class="na">bus</span><span class="pi">:</span> <span class="s">virtio</span>
          <span class="na">interfaces</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
            <span class="na">masquerade</span><span class="pi">:</span> <span class="pi">{}</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">br0-100</span>
            <span class="na">bridge</span><span class="pi">:</span> <span class="pi">{}</span>
        <span class="na">machine</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">1024M</span>
      <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">br0-100</span>
        <span class="na">multus</span><span class="pi">:</span>
          <span class="na">networkName</span><span class="pi">:</span> <span class="s">br0-100-l2</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">containerdisk</span>
          <span class="na">containerDisk</span><span class="pi">:</span>
            <span class="na">image</span><span class="pi">:</span> <span class="s">kubevirt/fedora-cloud-container-disk-demo</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cloudinitdisk</span>
          <span class="na">cloudInitNoCloud</span><span class="pi">:</span>
            <span class="na">networkData</span><span class="pi">:</span> <span class="pi">|</span>
              <span class="s">version: 2</span>
              <span class="s">ethernets:</span>
                <span class="s">eth1:</span>
                  <span class="s">addresses: [ 10.200.0.1/24 ]</span>
            <span class="na">userData</span><span class="pi">:</span> <span class="pi">|-</span>
              <span class="s">#!/bin/bash</span>
              <span class="s">echo "fedora" |passwd fedora --stdin</span>
              <span class="s">dnf -y install qemu-guest-agent</span>
              <span class="s">sudo systemctl enable qemu-guest-agent</span>
              <span class="s">sudo systemctl start qemu-guest-agent</span>
<span class="s">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kubevirt.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualMachine</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vmb</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">running</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="na">kubernetes.io/hostname</span><span class="pi">:</span> <span class="s">node02</span>
      <span class="na">domain</span><span class="pi">:</span>
        <span class="na">devices</span><span class="pi">:</span>
          <span class="na">disks</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">containerdisk</span>
              <span class="na">disk</span><span class="pi">:</span>
                <span class="na">bus</span><span class="pi">:</span> <span class="s">virtio</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cloudinitdisk</span>
              <span class="na">disk</span><span class="pi">:</span>
                <span class="na">bus</span><span class="pi">:</span> <span class="s">virtio</span>
          <span class="na">interfaces</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
            <span class="na">masquerade</span><span class="pi">:</span> <span class="pi">{}</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">br0-100</span>
            <span class="na">bridge</span><span class="pi">:</span> <span class="pi">{}</span>
        <span class="na">machine</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">1024M</span>
      <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">br0-100</span>
        <span class="na">multus</span><span class="pi">:</span>
          <span class="na">networkName</span><span class="pi">:</span> <span class="s">br0-100-l2</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">containerdisk</span>
          <span class="na">containerDisk</span><span class="pi">:</span>
            <span class="na">image</span><span class="pi">:</span> <span class="s">kubevirt/fedora-cloud-container-disk-demo</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cloudinitdisk</span>
          <span class="na">cloudInitNoCloud</span><span class="pi">:</span>
            <span class="na">networkData</span><span class="pi">:</span> <span class="pi">|</span>
              <span class="s">version: 2</span>
              <span class="s">ethernets:</span>
                <span class="s">eth1:</span>
                  <span class="s">addresses: [ 10.200.0.2/24 ]</span>
            <span class="na">userData</span><span class="pi">:</span> <span class="pi">|-</span>
              <span class="s">#!/bin/bash</span>
              <span class="s">echo "fedora" |passwd fedora --stdin</span>
              <span class="s">dnf -y install qemu-guest-agent</span>
              <span class="s">sudo systemctl enable qemu-guest-agent</span>
              <span class="s">sudo systemctl start qemu-guest-agent</span>
<span class="s">EOF</span>
</code></pre></div></div>

<p>Wait for the two VMs to be ready.
Eventually you will see something like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get vmi
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      AGE    PHASE     IP               NODENAME
vma      2m4s   Running   10.244.196.142   node01
vmb      2m4s   Running   10.244.140.86    node02
</code></pre></div></div>

<p>We can check that they have one secondary NIC without
address assigned:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get vmi <span class="nt">-o</span> yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## vma</span>
  <span class="na">interfaces</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">interfaceName</span><span class="pi">:</span> <span class="s">eth0</span>
    <span class="na">ipAddress</span><span class="pi">:</span> <span class="s">10.244.196.144</span>
    <span class="na">ipAddresses</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">10.244.196.144</span>
    <span class="pi">-</span> <span class="s">fd10:244::c48f</span>
    <span class="na">mac</span><span class="pi">:</span> <span class="s">02:4a:be:00:00:0a</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
  <span class="pi">-</span> <span class="na">interfaceName</span><span class="pi">:</span> <span class="s">eth1</span>
    <span class="na">ipAddress</span><span class="pi">:</span> <span class="s">10.200.0.1/24</span>
    <span class="na">ipAddresses</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">10.200.0.1/24</span>
    <span class="pi">-</span> <span class="s">fe80::4a:beff:fe00:b/64</span>
    <span class="na">mac</span><span class="pi">:</span> <span class="s">02:4a:be:00:00:0b</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">br0-100</span>
<span class="c1">## vmb</span>
  <span class="na">interfaces</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">interfaceName</span><span class="pi">:</span> <span class="s">eth0</span>
    <span class="na">ipAddress</span><span class="pi">:</span> <span class="s">10.244.140.84</span>
    <span class="na">ipAddresses</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">10.244.140.84</span>
    <span class="pi">-</span> <span class="s">fd10:244::8c53</span>
    <span class="na">mac</span><span class="pi">:</span> <span class="s">02:4a:be:00:00:0e</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
  <span class="pi">-</span> <span class="na">interfaceName</span><span class="pi">:</span> <span class="s">eth1</span>
    <span class="na">ipAddress</span><span class="pi">:</span> <span class="s">10.200.0.2/24</span>
    <span class="na">ipAddresses</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">10.200.0.2/24</span>
    <span class="pi">-</span> <span class="s">fe80::4a:beff:fe00:f/64</span>
    <span class="na">mac</span><span class="pi">:</span> <span class="s">02:4a:be:00:00:0f</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">br0-100</span>
</code></pre></div></div>

<p>Let’s finish this section by verifying connectivity between vma and vmb using <code class="language-plaintext highlighter-rouge">ping</code>. Open the console of vma virtual machine and use <code class="language-plaintext highlighter-rouge">ping</code> command with destination IP address 10.200.0.2, which is the address assigned to the secondary interface of vmb:</p>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>The user and password for this VMs is <code class="language-plaintext highlighter-rouge">fedora</code>, it was configured at cloudinit userData</p>


</div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virtctl console vma
ping 10.200.0.2 <span class="nt">-c</span> 3
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PING 10.200.0.2 <span class="o">(</span>10.200.0.2<span class="o">)</span>: 56 data bytes
64 bytes from 10.200.0.2: <span class="nb">seq</span><span class="o">=</span>0 <span class="nv">ttl</span><span class="o">=</span>50 <span class="nb">time</span><span class="o">=</span>357.040 ms
64 bytes from 10.200.0.2: <span class="nb">seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>50 <span class="nb">time</span><span class="o">=</span>379.742 ms
64 bytes from 10.200.0.2: <span class="nb">seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>50 <span class="nb">time</span><span class="o">=</span>404.066 ms

<span class="nt">---</span> 10.200.0.2 ping statistics <span class="nt">---</span>
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max <span class="o">=</span> 357.040/380.282/404.066 ms
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>In this blog post we used network components from KubeVirt project to connect two VMs on different nodes
through a linux bridge connected to a secondary NIC. This illustrates how VM traffic can be directed to a specific NIC
on a node using a secondary NIC on a VM.</p>

        </article>
        
        

<a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=Multiple Network Attachments with bridge CNI&url=https://www.kubevirt.io/2020/Multiple-Network-Attachments-with-bridge-CNI.html&screen_name=kubevirt" aria-label="Share this on Twitter">
  <i class="fab fa-twitter mr-1"></i> Tweet
</a>
<hr/>


      </div>
    </div>
  </div>
</div>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script src="/js/photoswipe-page.js">
</script>

    </main>

    <footer class="footer" role="footer">
      <div class="container-fluid">
  <div class="row justify-content-between">
    <div class="col-sm-12 col-md-5">
      <p>We are a <a href="https://cncf.io/">Cloud Native Computing Foundation</a> sandbox project.</p>
      <p><a href="https://cncf.io/"><img src="/assets/images/cncf-color.png" alt="Cloud Native Computing Foundation"/></a></p>
    </div>
    <div class="col-sm-12 col-md-5" style="text-align: center;">
      <p class="text-md-right">

        <a href="https://twitter.com/kubevirt" data-toggle="tooltip" data-placement="top" title="Follow us on Twitter!" aria-label="Visit us on Twitter" class="link-social-twitter">
          <i class="fab fa-twitter fa-lg"></i>
        </a>

        <a href="https://kubernetes.slack.com/archives/C8ED7RKFE" data-toggle="tooltip" data-placement="top" title="Join our Slack channel!" class="link-social-slack">
          <i class="fab fa-slack fa-lg"></i>
        </a>

        <a href="https://github.com/kubevirt" data-toggle="tooltip" data-placement="top" title="Check our GitHub!" class="link-social-github">
          <i class="fab fa-github fa-lg"></i>
        </a>

        <a href="https://groups.google.com/forum/#!forum/kubevirt-dev" data-toggle="tooltip" data-placement="top" title="Join our mailing list!" class="link-social-mail">
          <i class="fas fa-envelope fa-lg"></i>
        </a>

        <a href="https://calendar.google.com/calendar/u/0/embed?src=kubevirt@cncf.io" data-toggle="tooltip" data-placement="top" title="See our events calendar!" class="link-social-calendar">
          <i class="fas fa-calendar fa-lg"></i>
        </a>

        <a href="https://www.youtube.com/channel/UC2FH36TbZizw25pVT1P3C3g/videos" data-toggle="tooltip" data-placement="top" title="Subscribe to our YouTube channel!" class="link-social-youtube">
          <i class="fab fa-youtube fa-lg"></i>
        </a>

      </p>
    </div>
  </div>
  <div class="row">
    <div class="col text-sm-left footer-licensing" style="text-align: center;">
      Copyright 2022 The KubeVirt Contributors<br>
      Copyright 2022 The Linux Foundation. All Rights Reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage</a> page.<br>
      This site is powered by <a href="https://www.netlify.com/legal/open-source-policy/">Netlify</a>.
      <p class="privacy-statement text-sm-left" style="text-align: center;">
        <a href="/privacy" class="privacy-statement-link">Privacy Statement</a>
      </p>
  </div>
</div>
<script src="/js/copy.js"></script>

    </footer>

    <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js" integrity="sha384-3LK/3kTpDE/Pkp8gTNp2gR/2gOiwQ6QaO7Td0zV76UFJVhqLl4Vl3KL1We6q6wR9" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <script src="/js/kubevirt-io.js"></script>
    <!-- Photoswipe -->
    <!-- Core JS file -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.js"></script>
    <!-- UI JS file -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

    <!-- This comes from DTM/DPAL and must be latest entry in body-->

    <script type="text/javascript">
        if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
            _satellite.pageBottom();
        }
    </script>
  </body>
</html>
