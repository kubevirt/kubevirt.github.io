<!doctype html>
<html lang="en">

  <head>
    <!-- Adding Adobe Analytics -->
    <script id="dpal" src="//www.redhat.com/ma/dpal.js" type="text/javascript"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1, shrink-to-fit=no" >
    <meta name="go-import" content="kubevirt.io/kubevirt git https://github.com/kubevirt/kubevirt">
    <meta name="go-import" content="kubevirt.io/client-go git https://github.com/kubevirt/client-go">
    <meta name="go-import" content="kubevirt.io/containerized-data-importer git https://github.com/kubevirt/containerized-data-importer">
    <meta name="go-import" content="kubevirt.io/hostpath-provisioner git https://github.com/kubevirt/hostpath-provisioner">
    <meta name="go-import" content="kubevirt.io/hostpath-provisioner-operator git https://github.com/kubevirt/hostpath-provisioner-operator">
    <meta name="go-import" content="kubevirt.io/qe-tools git https://github.com/kubevirt/qe-tools">
    <meta name="go-import" content="kubevirt.io/machine-remediation git https://github.com/kubevirt/machine-remediation">
    <meta name="go-import" content="kubevirt.io/cloud-provider-kubevirt git https://github.com/kubevirt/cloud-provider-kubevirt">
    <meta name="go-import" content="kubevirt.io/controller-lifecycle-operator-sdk git https://github.com/kubevirt/controller-lifecycle-operator-sdk">
    <meta name="go-import" content="kubevirt.io/ssp-operator git https://github.com/kubevirt/ssp-operator">
    <meta name="go-import" content="kubevirt.io/cpu-nfd-plugin git https://github.com/kubevirt/cpu-nfd-plugin">
    <meta name="go-import" content="kubevirt.io/containerized-data-importer-api git https://github.com/kubevirt/containerized-data-importer-api">
    <meta name="go-import" content="kubevirt.io/api git https://github.com/kubevirt/api">
    <meta name="go-import" content="kubevirt.io/node-maintenance-operator git https://github.com/kubevirt/node-maintenance-operator">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/favicon/site.webmanifest">
    <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    <meta name="google-site-verification" content="eaETLLM6xObn1li9l9eU8lNIBgBpU0OQLXV1faU1svE" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://kubevirt.io//2020/Customizing-images-for-containerized-vms.html">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
    
    <title>Customizing images for containerized VMs part I | KubeVirt.io</title>
    <!-- # Opengraph protocol properties: https://ogp.me/ -->
    <meta name="author" content="Alberto Losada Grande" >
    <meta property="og:type" content="article" >
    <meta name="twitter:card" content="summary">
    <meta name="description" content="A use case is exposed where containerized VMs running on top of Kubernetes ease the deployment of standardized VMs required by software developers. In this first part, we focus on creating standard images using different tools and then containerize them so that they can be stored in a container registry.">
    <meta name="keywords" content="kubevirt, kubernetes, virtual machine, okd, containerDisk, registry, composer-cli, virt-customize, builder tool" >
    <meta property="og:title" content="Customizing images for containerized VMs part I | KubeVirt.io">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kubevirt.io//2020/Customizing-images-for-containerized-vms.html" >
    <meta property="og:image" content="https://kubevirt.io//assets/images/KubeVirt_logo_color.png">
    <meta property="og:description" content="A use case is exposed where containerized VMs running on top of Kubernetes ease the deployment of standardized VMs required by software developers. In this first part, we focus on creating standard images using different tools and then containerize them so that they can be stored in a container registry." >
    <meta property="og:site_name" content="KubeVirt.io" >
    <meta property="og:article:author" content="Alberto Losada Grande" >
    <meta property="og:article:published_time" content="2020-12-10 00:00:00 +0000" >
    <meta name="twitter:title" content="Customizing images for containerized VMs part I | KubeVirt.io">
    <meta name="twitter:description" content="A use case is exposed where containerized VMs running on top of Kubernetes ease the deployment of standardized VMs required by software developers. In this first part, we focus on creating standard images using different tools and then containerize them so that they can be stored in a container registry.">

    <link type="application/atom+xml" rel="alternate" href="https://kubevirt.io//feed.xml" title="KubeVirt.io" />
    <script src="//code.jquery.com/jquery.min.js"></script>
    
    <!-- Photoswipe.com gallery-->

    <!-- Core CSS file -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.css">

    <!-- Skin CSS file (styling of UI - buttons, caption, etc.)
        In the folder of skin CSS file there are also:
        - .png and .svg icons sprite,
        - preloader.gif (for browsers that do not support CSS animations) -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css">
</head>


  <body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" role="navigation">
        <a class="navbar-brand" href="/">
    <img src="/assets/images/KubeVirt_logo_color.svg" class="navbar-brand-image d-inline-block align-top" alt="KubeVirt.io">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <i class="fas fa-th-large"></i>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
      

      
        <li  class="nav-item active" >
          <a class="nav-link text-uppercase" href="/blogs/">Blogs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/videos/">Videos</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/gallery/">Gallery</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="//kubevirt.io/user-guide">Docs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/labs/">Labs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/community/">Community</a>
        </li>
      

      <li class='nav-item'>
        <form action="/search.html" class="nav-item__search" method="get" autocomplete="off">
          <div class="autocomplete" style="width:150px;">
            <input type="text" id="search-input" class="docs-search--input" placeholder="search term" name="query">
          </div>
          <input id="search-button" type="submit" value="🔍" disabled='true'>
        </form>
      </li>

    </ul>
  </div>
<script>
function autocomplete(inp, arr) {
  /*the autocomplete function takes two arguments,
  the text field element and an array of possible autocompleted values:*/
  var currentFocus;
  /*execute a function when someone writes in the text field:*/
  inp.addEventListener("input", function(e) {
      var a, b, i, val = this.value;
      /*close any already open lists of autocompleted values*/
      closeAllLists();
      if (!val) { return false;}
      currentFocus = -1;
      /*create a DIV element that will contain the items (values):*/
      a = document.createElement("DIV");
      a.setAttribute("id", this.id + "autocomplete-list");
      a.setAttribute("class", "autocomplete-items");
      /*append the DIV element as a child of the autocomplete container:*/
      this.parentNode.appendChild(a);
      /*for each item in the array...*/
      for (i = 0; i < arr.length; i++) {
        /*check if the item starts with the same letters as the text field value:*/
        if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
          /*create a DIV element for each matching element:*/
          b = document.createElement("DIV");
          /*make the matching letters bold:*/
          b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
          b.innerHTML += arr[i].substr(val.length);
          /*insert a input field that will hold the current array item's value:*/
          b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
          /*execute a function when someone clicks on the item value (DIV element):*/
              b.addEventListener("click", function(e) {
              /*insert the value for the autocomplete text field:*/
              inp.value = this.getElementsByTagName("input")[0].value;
              /*close the list of autocompleted values,
              (or any other open lists of autocompleted values:*/
              closeAllLists();
          });
          a.appendChild(b);
        }
      }
  });
  /*execute a function presses a key on the keyboard:*/
  inp.addEventListener("keydown", function(e) {
      document.getElementById("search-button").disabled= undefined;
      var x = document.getElementById(this.id + "autocomplete-list");
      if (x) x = x.getElementsByTagName("div");
      if (e.keyCode == 40) {
        /*If the arrow DOWN key is pressed,
        increase the currentFocus variable:*/
        currentFocus++;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 38) { //up
        /*If the arrow UP key is pressed,
        decrease the currentFocus variable:*/
        currentFocus--;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 13) {
        /*If the ENTER key is pressed, prevent the form from being submitted,*/
        if (currentFocus > -1) {
          /*and simulate a click on the "active" item:*/
          if (x) {
            x[currentFocus].click();
            e.preventDefault();
          }
        }
        if (document.getElementById("search-input").value == "") {
          e.preventDefault();
        }
      }
  });
  function addActive(x) {
    /*a function to classify an item as "active":*/
    if (!x) return false;
    /*start by removing the "active" class on all items:*/
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    /*add class "autocomplete-active":*/
    x[currentFocus].classList.add("autocomplete-active");
  }
  function removeActive(x) {
    /*a function to remove the "active" class from all autocomplete items:*/
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }
  function closeAllLists(elmnt) {
    /*close all autocomplete lists in the document,
    except the one passed as an argument:*/
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
      x[i].parentNode.removeChild(x[i]);
    }
  }
}
/*execute a function when someone clicks in the document:*/
document.addEventListener("click", function (e) {
    closeAllLists(e.target);
});
}
</script>

<script>
var mykeywords = ["libvirt", "KubeVirt", "ClearContainers", "virtlet", "CRI", "OpenStack", "ovirt", "release notes", "changelog", "hilights", "network", "flannel", "kubevirt-ansible", "Skydive", "openshift", "glusterfs", "heketi", "virtual machine", "weavenet", "custom resources", "kubevirt objects", "objects", "VirtualMachine", "api", "rbac", "roles", "storage", "ovn", "kubetron", "neutron", "vscode", "development", "debug", "istio", "iptables", "tproxy", "service mesh", "ebtables", "docker", "container", "build", "multus", "roadmap", "kvm", "qemu", "device plugins", "unit testing", "review", "hugepages", "kubevirtci", "ci-cd", "cicd", "memory", "overcommitment", "networking", "CNI", "multiple networks", "ovs-cni", "import", "clone", "upload", "disk image", "cdi", "datavolumes", "volume types", "serviceaccount", "ignition", "coreos", "rhcos", "kubecon", "conference", "gcp", "autodeployer", "metrics", "prometheus", "grafana", "federation", "kubefed", "multicluster", "HCO", "hyperconverged operator", "ansible", "vagrant", "lifecycle", "virtual machines", "website", "community", "vm import", "node drain", "eviction", "nmo", "condition types", "Condition types", "CNCF", "sandbox", "lab", "cri-o", "quickstart", "homelab", "kubernetes", "kubevirt installation", "rook", "ceph", "ntp", "chronyd", "prow", "infrastructure", "kubevirt-tutorial", "CI-CD", "continuous integration", "jenkins", "noVNC", "console", "KubeCon", "cloudnativecon", "America", "talk", "gathering", "contra-lib", "admin", "operations", "create vm", "start vm", "connect to console", "connect to ssh", "stop vm", "remove vm", "operator manual", "basic operations", "laboratory", "installing kubevirt", "use kubevirt", "admin operations", "CDI", "containerized data importer", "octant", "okd", "openshift console", "cockpit", "user interface", "web interface", "virtVNC", "OKD console", "kubevirt upgrade", "upgrading", "OpenShift web console", "OKD", "video", "virtual machine management", "NUMA", "CPU pinning", "QEMU", "KVM", "GPU", "NVIDIA", "GPU workloads", "pass-through", "passthrough", "kubevirt", "Microsoft Windows kubernetes", "Microsoft Windows container", "Windows", "VM", "Advanced VM scheduling", "affinity", "scheduling", "topologyKeys", "Live Migration", "design", "architecture", "security", "operation", "images", "Kubernetes", "windows", "common-templates", "minikube", "addons", "oVirt", "kubevirt-hyperconverged", "cnao", "cluster-network-addons-operator", "kubernetes-nmstate", "nmstate", "bridge", "containerDisk", "registry", "composer-cli", "virt-customize", "builder tool", "prometheus-operator", "node-exporter", "monitoring", "event", "Tekton Pipelines", "KubeVirt Tekton Tasks", "vGPU", "Intel", "Fedora", "go", "authentication", "mesh", "AWS", "EC2", "AMI", "real-time", "CPUManager", "live migration", "dedicated network", "Kubevirt", "load-balancer", "MetalLB", "instancetypes", "preferences", "VirtualMachineInstancetype", "VirtualMachinePreference", ]
autocomplete(document.getElementById("search-input"), mykeywords);
</script>

<script src="/js/clipboard.min.js"></script>

    </nav>

    <main role="main" style="margin-top: 60px;">
      <div class="container">
  <div class="row">
    <div class="col">
      <div class="post">
        <header class="post-header">
          <h1></h1>
          <h1 class="post-title">Customizing images for containerized VMs part I</h1>
          <div class="post-info">
            <span class="post-author">Author: Alberto Losada Grande</span>
            <div>
              <span class="post-category-name">
                Tags: <a href="/tag/kubevirt">kubevirt</a>&nbsp;|&nbsp;<a href="/tag/kubernetes">kubernetes</a>&nbsp;|&nbsp;<a href="/tag/virtual-machine">virtual machine</a>&nbsp;|&nbsp;<a href="/tag/okd">okd</a>&nbsp;|&nbsp;<a href="/tag/containerdisk">containerDisk</a>&nbsp;|&nbsp;<a href="/tag/registry">registry</a>&nbsp;|&nbsp;<a href="/tag/composer-cli">composer-cli</a>&nbsp;|&nbsp;<a href="/tag/virt-customize">virt-customize</a>&nbsp;|&nbsp;<a href="/tag/builder-tool">builder tool</a>
              </span>
            </div>
            <div>
              <span class="post-meta">Publication Date: December 10, 2020  </span>
            </div>
            <div>
              <span class="post-category-name">
                Category: news
              </span>
            </div>

          </div>
        </header>
        <article class="post-content">
          <p><b>Table of contents</b></p>

<!-- TOC depthFrom:2 insertAnchor:false orderedList:false updateOnSave:true withLinks:true -->

<ul>
  <li><a href="#the-vision">The vision</a></li>
  <li><a href="#preparation-of-the-environment">Preparation of the environment</a>
    <ul>
      <li><a href="#configuration-of-the-builder-image-server">Configuration of the Builder image server</a></li>
    </ul>
  </li>
  <li><a href="#building-standard-centos-8-image">Building standard CentOS 8 image</a>
    <ul>
      <li><a href="#image-creation-with-builder-tool">Image creation with Builder Tool</a></li>
      <li><a href="#verify-the-custom-built-image">Verify the custom-built image</a></li>
      <li><a href="#image-tailoring-with-virt-customize">Image tailoring with virt-customize</a></li>
    </ul>
  </li>
  <li><a href="#building-a-standard-centos-7-image-from-cloud-images">Building a standard CentOS 7 image from cloud images</a>
    <ul>
      <li><a href="#image-creation-with-virt-customize">Image creation with virt-customize</a></li>
    </ul>
  </li>
</ul>

<!-- /TOC -->

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>The content of this article has been divided into two: this one, which is the first part, explains how to create a golden image using different tools such as <em>Builder Tool</em> and <em>virt-customize</em>. Once the custom-built image is ready, it is containerized so that it can be uploaded and stored into a container registry. The second part deals with the different ways the developers can deploy, modify and connect to the <code class="language-plaintext highlighter-rouge">VirtualMachineInstance</code> running in the OKD Kubernetes cluster.</p>


</div></div>
<h2 id="the-vision">The vision</h2>

<p>If you work for a software factory, some kind of development environment standardization is probably in place. There are a lot of approaches which fit different use cases. In this blog post, our example company has allowed developers to choose their preferred editing tools and debugging environment locally to their workstations. However, before committing their changes to a Git repository, they need to validate them in a specifically tailored environment. This environment, due to legal restrictions, contains exact versions of the libraries, databases, web server or any other software previously agreed with customers.</p>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>Aside from the pre-commit environments, the company already has an automated continuous integration workflow composed by several shared environments: <em>development, integration and production</em>.</p>


</div></div>
<p>This blog post focuses on showing a use case where containerized VMs running on top of Kubernetes ease the deployment and creation of standardized VMs to our developers. These VMs are meant to be ephemeral. However, if necessary, additional non-persistent disk or shared persistent storage can be attached so that important information can be kept safe.</p>

<p>Along the process, different approaches and tools to create custom VM images that will be stored in a corporate registry are detailed. Containerizing VMs means adapting them so that they can be saved in a container registry. Being able to manage VMs as container images leverages the benefits of a container registry, such as:</p>

<ul>
  <li>The registry becomes a <strong>source of truth</strong> for the VMs you want to run. Everybody can list all VMs available searching on a centralized point.</li>
  <li>The container registry, depending on the storage size, contains historical information of all the VMs, which might have multiple different versions, identified by their tags. Any developer with the proper permissions is able to run any specific version of your standardized VM.</li>
  <li>It is the unique point where all your VMs are stored avoiding having them spread all over your infrastructure.</li>
</ul>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>A container image registry is a service that stores container images, and is hosted either by a third-party or as a public/private registry such as Docker Hub, Quay, and so on.</p>


</div></div>
<p>The ambitious goal is allowing the developers to deploy standardized VMs on the current Kubernetes infrastructure. Then, execute the required tests and if they are good, push the code to the corporate Git repositories and delete the VM eventually.</p>

<p>This goal is divided into three main procedures:</p>

<ul>
  <li>Create custom standardized VM images, also known as golden images.</li>
  <li>Containerize the resulting golden VM images.</li>
  <li>Deploy the proper VM images from the corporate registry into the OKD Kubernetes cluster.</li>
</ul>

<p><br /></p>

<h2 id="preparation-of-the-environment">Preparation of the environment</h2>

<p>Running containerized VMs in KubeVirt uses the <a href="https://kubevirt.io/user-guide/virtual_machines/disks_and_volumes/#containerdisk">containerDisk</a> feature which provides the ability to store and distributed VM disks in the container image registry. The disks are pulled from the container registry and reside on the local node hosting the VMs that consume the disks.</p>

<p>The company already have an <a href="https://www.okd.io/">OKD 4 Kubernetes cluster</a> installed which provides out of the box a container registry and some required security features such as <em>Role Based Access Controls (RBAC)</em> and <em>Security Context Constraints (SCC)</em>.</p>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>In the <a href="https://blog.openshift.com/">OpenShift blog</a> there is a post called <a href="https://blog.openshift.com/enterprise-kubernetes-with-openshift-part-one/">Enterprise Kubernetes with OpenShift</a> where you can find valuable information between the similarities and differences between OKD and Kubernetes.</p>


</div></div>
<p>On top of the OKD cluster, KubeVirt is required so that we can run our virtual machines. The installation process is pretty well detailed in the <a href="https://kubevirt.io/pages/cloud.html">KubeVirt’s documentation</a>. Below it is shown how KubeVirt components can be seen from the OKD web console.</p>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>KubeVirt version deployed is <strong>0.34.2</strong> which is the latest at the moment of writing.</p>


</div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$KUBEVIRT_VERSION</span>
0.34.2

<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://github.com/kubevirt/kubevirt/releases/download/<span class="k">${</span><span class="nv">KUBEVIRT_VERSION</span><span class="k">}</span>/kubevirt-operator.yaml
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://github.com/kubevirt/kubevirt/releases/download/<span class="k">${</span><span class="nv">KUBEVIRT_VERSION</span><span class="k">}</span>/kubevirt-cr.yaml
</code></pre></div></div>

<p><br /></p>

<div class="my-gallery" itemscope="" itemtype="http://schema.org/ImageGallery">
  <figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
    <a href="/assets/2020-12-01-Customizing-images-for-containerized-vms/kubevirt_okd.png" itemprop="contentUrl" data-size="1110x520">
      <img src="/assets/2020-12-01-Customizing-images-for-containerized-vms/kubevirt_okd.png" itemprop="thumbnail" width="100%" alt="VM to VM" />
    </a>
    <figcaption itemprop="caption description"></figcaption>
  </figure>
</div>

<div class="premonition warning"><div class="fa fa-exclamation-circle"></div><div class="content"><p class="header">Warning</p><p><strong>oc</strong> is the specific command-line tool for OKD, however, it is based in <em>kubectl</em> plus some additional features detailed here. It is probably that along the blog post, you can find executions with <em>oc</em> or <em>kubectl</em> interchangeably.</p>


</div></div>
<p><code class="language-plaintext highlighter-rouge">containerDisks</code> are created from RAW or <a href="https://www.linux-kvm.org/page/Qcow2">QCOW2</a> virtual machine images. Nevertheless, virtual machine images with all the agreed software and proper configuration must be created previously. The company currently uses CentOS 7 as their approved base operating system to run their applications. However, during the last months, it has been encouraging to move to the recently released version 8 of CentOS.</p>

<p>From a long time they had been using the prebuilt <a href="https://cloud.centos.org/centos/">CentOS cloud images</a> with <a href="http://libguestfs.org/virt-customize.1.html">virt-customize</a>, which allowed them to modify the prebuilt cloud images. As a trade-off, they had to trust on the cloud image provided by CentOS or verify if new packages were added on each release.</p>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p><strong>virt-customize</strong> can customize a virtual machine (disk image) by installing packages, editing configuration files, and so on. Virt-customize modifies the guest or disk image in place.</p>


</div></div>
<p>Now, they are starting to use a new tool called <a href="https://docs.centos.org/en-US/centos/install-guide/Composer/">Image Builder</a> that creates deployment-ready customized system images from scratch. Furthermore, there is an integration with Cockpit where you can create custom CentOS images in various formats including QCOW2 for OpenStack, AMI (Amazon Machine Image), VHD (Azure Disk Image) etc. from a friendly user interface.</p>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>There are a lot of tools that can accomplish the objective of creating custom images. Here we are focusing on two: <code class="language-plaintext highlighter-rouge">virt-customize</code> and <code class="language-plaintext highlighter-rouge">Image Builder</code>.</p>


</div></div>
<p>Along this blog post, both tools are used together in the image building process, leveraging their strengths. In the following diagram is depicted the different agents that take part in the process of running our standardized VMs in Kubernetes. This workflow includes the creation and customization of the images, their containerization, storing them into the OKD container registry and finally the creation of the VMs in Kubernetes by the employees.</p>

<div class="my-gallery" itemscope="" itemtype="http://schema.org/ImageGallery">
  <figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
    <a href="/assets/2020-12-01-Customizing-images-for-containerized-vms/diagram-customizing-images.png" itemprop="contentUrl" data-size="1110x320">
      <img src="/assets/2020-12-01-Customizing-images-for-containerized-vms/diagram-customizing-images.png" itemprop="thumbnail" width="100%" alt="VM to VM" />
    </a>
    <figcaption itemprop="caption description">okd imageStream devstation</figcaption>
  </figure>
</div>

<h3 id="configuration-of-the-builder-image-server">Configuration of the Builder image server</h3>

<p>In order to prepare the building environment, it is recommended to install Image Builder in a dedicated server as it has specific security requirements. Actually, the <code class="language-plaintext highlighter-rouge">lorax-composer</code> which is one of its components doesn’t work properly with SELinux running, as it installs an entire OS image in an alternate directory.</p>

<div class="premonition warning"><div class="fa fa-exclamation-circle"></div><div class="content"><p class="header">Warning</p><p>As shown in the <a href="https://weldr.io/Running-Composer-on-RHEL/">lorax-composer documentation</a> SELinux must be disabled. However, I have been able to create custom images successfully with SELinux enabled. In case you find any problems during your building, check the <code class="language-plaintext highlighter-rouge">lorax-composer</code> logs in journal in order to get more detailed information.</p>


</div></div>
<p>Here it is a table where the software required to run the builds along with the versions have been used.</p>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>Operating System is <strong>CentOS 8</strong> since CentOS 7 Image Builder is still an <a href="https://docs.centos.org/en-US/centos/install-guide/Composer/">experimental feature</a></p>


</div></div>
<p>| Component     | Version                                                                                            |
| ——— | ———————————————————————————————– |
| Operating System  | CentOS Linux release 8.2.2004 (Core) |
| Libvirt | libvirtd (libvirt) 4.5.0                               |
| virt-customize | virt-customize 1.38.4rhel=8,release=14.module_el8.1.0+248+298dec18,libvirt |
| Image Builder | lorax-composer (28.14.42-2), composer-cli (composer-cli-28.14.42-2), cockpit-composer (cockpit-composer-12.1-1.el8.noarch) |</p>

<p>Once the builder image server is provisioned with latest CentOS 8, the <code class="language-plaintext highlighter-rouge">Virtualization Host</code> group package is installed. It will be required to test our customized images locally before containerizing and pushing them to the OKD registry.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum groupinstall <span class="s2">"Virtualization Host"</span> <span class="nt">-y</span>
systemctl <span class="nb">enable </span>libvirtd <span class="nt">--now</span>
</code></pre></div></div>

<p><br /></p>

<p>Next, <code class="language-plaintext highlighter-rouge">virt-customize</code> is installed from the <code class="language-plaintext highlighter-rouge">libguestfs-tools</code> package along with the Image Builder. The latest is composed by lorax-composer, the Cockpit composer plugin and the composer-cli, which will be used to interact directly with Composer using command-line.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnf <span class="nb">install</span> <span class="nt">-y</span> libguestfs-tools lorax-composer composer-cli cockpit-composer
systemctl <span class="nb">enable </span>lorax-composer.socket
systemctl <span class="nb">enable </span>lorax-composer <span class="nt">--now</span>
systemctl start cockpit
</code></pre></div></div>

<p><br /></p>

<p>Then, the local firewall is configured so that we can connect to the Cockpit web user interface from our workstation.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewall-cmd <span class="nt">--add-service</span><span class="o">=</span>cockpit <span class="o">&amp;&amp;</span> firewall-cmd <span class="nt">--add-service</span><span class="o">=</span>cockpit <span class="nt">--permanent</span>
</code></pre></div></div>

<p>Finally, connect to the Cockpit user interface by typing the IP or name of the Builder image server and port <em>TCP/9090</em> (Cockpit’s default) in your favourite web browser. Then, log in with a local administrator account.</p>

<div class="my-gallery" itemscope="" itemtype="http://schema.org/ImageGallery">
  <figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
    <a href="/assets/2020-12-01-Customizing-images-for-containerized-vms/cockpit-gui.png" itemprop="contentUrl" data-size="1110x484">
      <img src="/assets/2020-12-01-Customizing-images-for-containerized-vms/cockpit-gui.png" itemprop="thumbnail" width="100%" alt="VM to VM" />
    </a>
    <figcaption itemprop="caption description"></figcaption>
  </figure>
</div>

<p>The following image shows the Image Build plugin web page. Actually, what it is depicted are the different Image Build blueprints that are shipped by default. <em>The blueprint</em> defines what should be included in your image. This includes packages, users, files, server settings …</p>

<div class="my-gallery" itemscope="" itemtype="http://schema.org/ImageGallery">
  <figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
    <a href="/assets/2020-12-01-Customizing-images-for-containerized-vms/cockpit-first-page.png" itemprop="contentUrl" data-size="1110x333">
      <img src="/assets/2020-12-01-Customizing-images-for-containerized-vms/cockpit-first-page.png" itemprop="thumbnail" width="100%" alt="VM to VM" />
    </a>
    <figcaption itemprop="caption description"></figcaption>
  </figure>
</div>

<div class="premonition error"><div class="fa fa-exclamation-triangle"></div><div class="content"><p class="header">Error</p><p>If Cockpit’s web UI is not working, take a look at the output of the lorax service with the command:</p>


</div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>journalctl <span class="nt">-fu</span> lorax-composer
</code></pre></div></div>

<h2 id="building-standard-centos-8-image">Building standard CentOS 8 image</h2>

<p>It is time to create our standardized CentOS 8 image or also called golden CentOS 8 image. This image will be built from the ground up using the Image Builder tool.</p>

<h3 id="image-creation-with-builder-tool">Image creation with Builder Tool</h3>

<p>The easiest way to start is creating a new blueprint (devstation-centos8) from the Cockpit user interface. This will produce a scaffold file where all the required modifications can be made. Here it is shown the process of creation a new blueprint from Cockpit:</p>

<div class="my-gallery" itemscope="" itemtype="http://schema.org/ImageGallery">
  <figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
    <a href="/assets/2020-12-01-Customizing-images-for-containerized-vms/create_blueprint.png" itemprop="contentUrl" data-size="1110x449">
      <img src="/assets/2020-12-01-Customizing-images-for-containerized-vms/create_blueprint.png" itemprop="thumbnail" width="100%" alt="VM to VM" />
    </a>
    <figcaption itemprop="caption description"></figcaption>
  </figure>
</div>

<p>I would also suggest adding some users and all the packages you want to install from the user interface. In our case, we are going to create the following users by clicking on the details tab of the new blueprint. In both cases, the password is known by the respective group of users and also belongs to the wheel group.</p>

<table>
  <thead>
    <tr>
      <th>Users</th>
      <th>Note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>sysadmin</td>
      <td>Privileged user owned by the Systems Engineering team to troubleshoot and have access to the VM</td>
    </tr>
    <tr>
      <td>developer</td>
      <td>These are the credentials used by the developers to access the VM</td>
    </tr>
  </tbody>
</table>

<div class="my-gallery" itemscope="" itemtype="http://schema.org/ImageGallery">
  <figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
    <a href="/assets/2020-12-01-Customizing-images-for-containerized-vms/users.png" itemprop="contentUrl" data-size="1110x380">
      <img src="/assets/2020-12-01-Customizing-images-for-containerized-vms/users.png" itemprop="thumbnail" width="100%" alt="VM to VM" />
    </a>
    <figcaption itemprop="caption description"></figcaption>
  </figure>
</div>

<p>Next, select the packages to include. Add the proper version of the package already agreed with the customer.</p>

<table>
  <thead>
    <tr>
      <th>Package</th>
      <th>Version</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>httpd</td>
      <td>2.4.37</td>
    </tr>
    <tr>
      <td>mod_ssl</td>
      <td>2.4.37</td>
    </tr>
    <tr>
      <td>php</td>
      <td>7.2.24</td>
    </tr>
    <tr>
      <td>mariadb-server</td>
      <td>10.3.17</td>
    </tr>
    <tr>
      <td>openssh-server</td>
      <td>latest</td>
    </tr>
  </tbody>
</table>

<p>At this point, you already have a blueprint template to start working. In addition to using the web console, you can also use the <strong>Image Builder CLI</strong> to create images. When using the CLI, you have access to a few more customization options, such as managing firewall rules or download files from Git. Since we already have installed the composer-cli package in the <a href="#configuration-of-the-builder-image-server">Image Builder server</a>, let’s use it to further customize our golden image.</p>

<p>First, access to the Builder Image server and download the custom blueprint called <code class="language-plaintext highlighter-rouge">devstation-centos8</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>composer-cli blueprints list
devstation-centos8
example-atlas
example-development
Example-http-server

<span class="nv">$ </span>composer-cli blueprints save devstation-centos8
<span class="nv">$ </span><span class="nb">ls
</span>devstation-centos8.toml
</code></pre></div></div>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>All composer-cli options are documented in the <a href="https://weldr.io/lorax/composer-cli.html">official webpage</a>. Take a look if you need further detail.</p>


</div></div>
<p>Now, let’s edit the <code class="language-plaintext highlighter-rouge">devstation-centos8.toml</code> file which is in charge of building our custom image.</p>

<ul>
  <li>The time zone has been added to match Europe/Madrid with proper NTP servers.</li>
  <li>The kernel has been modified to allow connection via console.</li>
  <li>Several firewall rules have been added to allow our services being accessed from outside.</li>
  <li>Some services have been configured so that they are enabled and started at boot.</li>
  <li>A Git repository has been configured to be cloned. Actually, it is a Git repository that contains a manual detailing how the custom image is configured and how it must be used.</li>
</ul>

<div class="premonition warning"><div class="fa fa-exclamation-circle"></div><div class="content"><p class="header">Warning</p><p>It is important to add console as a kernel option since the Builder Image tool disables access to serial console by default. It will allow the <em>virtctl</em> command to connect to the VM while it is booting in our OKD Kubernetes cluster.</p>


</div></div>
<p>This is the final building configuration file, it can be downloaded from <a href="/assets/2020-12-01-Customizing-images-for-containerized-vms/devstation-centos8.toml">here</a></p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">name</span> <span class="p">=</span> <span class="s">"devstation-centos8"</span>
<span class="py">description</span> <span class="p">=</span> <span class="s">"A developer station"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.0.1"</span>
<span class="py">modules</span> <span class="p">=</span> <span class="p">[]</span>
<span class="py">groups</span> <span class="p">=</span> <span class="p">[]</span>

<span class="nn">[[packages]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"httpd"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"2.4.37"</span>

<span class="nn">[[packages]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"mod_ssl"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"2.4.37"</span>

<span class="nn">[[packages]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"php"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"7.2.24"</span>

<span class="nn">[[packages]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"mariadb-server"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"10.3.17"</span>

<span class="nn">[[packages]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"openssh-server"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"*"</span>

<span class="nn">[customizations]</span>
<span class="py">hostname</span> <span class="p">=</span> <span class="s">"devstation"</span>

<span class="nn">[customizations.kernel]</span>
<span class="py">append</span> <span class="p">=</span> <span class="py">"console</span><span class="p">=</span><span class="err">tty</span><span class="mi">0</span> <span class="py">console</span><span class="p">=</span><span class="err">ttyS</span><span class="mi">0</span><span class="p">,</span><span class="mi">19200</span><span class="err">n</span><span class="mi">81</span><span class="s">"</span><span class="err">
</span>
<span class="nn">[customizations.timezone]</span>
<span class="py">timezone</span> <span class="p">=</span> <span class="s">"Europe/Madrid"</span>
<span class="py">ntpservers</span> <span class="p">=</span> <span class="p">[</span><span class="s">"0.europe.pool.ntp.org"</span><span class="p">,</span> <span class="s">"1.europe.pool.ntp.org"</span><span class="p">]</span>

<span class="nn">[[customizations.user]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"sysadmin"</span>
<span class="py">description</span> <span class="p">=</span> <span class="s">"Company Systems Admin"</span>
<span class="py">password</span> <span class="p">=</span> <span class="s">"$6$ZGmDxvGu3Q0M4RO/$KkfU0bD32FrLNpUCWEL8sy3dknJVyqExoy.NJMOcSCRjpt1H6sFKFjx8mFWn8H5CWTP7.bibPLBrRSRq3MrDb."</span>
<span class="py">home</span> <span class="p">=</span> <span class="s">"/home/sysadmin/"</span>
<span class="py">shell</span> <span class="p">=</span> <span class="s">"/usr/bin/bash"</span>
<span class="py">groups</span> <span class="p">=</span> <span class="p">[</span><span class="s">"users"</span><span class="p">,</span> <span class="s">"wheel"</span><span class="p">]</span>

<span class="nn">[[customizations.user]]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"developer"</span>
<span class="py">description</span> <span class="p">=</span> <span class="s">"developer"</span>
<span class="py">groups</span> <span class="p">=</span> <span class="nn">["wheel"]</span>
<span class="py">password</span> <span class="p">=</span> <span class="s">"$6$wlIgNacMnqCcXn3o$mPpw0apT4iZ3jDq0q6epXN3xCmNN.oVGFW.Gvu9r0nDVX.FXY3iCwfFkfPEcmhj7Kxw4Ppoes2LsUzPtNRjez0"</span>

<span class="nn">[customizations.services]</span>
<span class="py">enabled</span> <span class="p">=</span> <span class="nn">["httpd","mariadb","sshd"]</span>

<span class="nn">[customizations.firewall.services]</span>
<span class="py">enabled</span> <span class="p">=</span> <span class="nn">["http","https","mysql","ssh"]</span>

<span class="nn">[[repos.git]]</span>
<span class="py">rpmname</span> <span class="p">=</span> <span class="s">"manual"</span>
<span class="py">rpmversion</span> <span class="p">=</span> <span class="s">"1.0"</span>
<span class="py">rpmrelease</span> <span class="p">=</span> <span class="s">"1"</span>
<span class="py">summary</span> <span class="p">=</span> <span class="s">"Manual how to work with devstation"</span>
<span class="py">repo</span> <span class="p">=</span> <span class="s">"https://github.com/alosadagrande/lorax"</span>
<span class="py">ref</span> <span class="p">=</span> <span class="s">"master"</span>
<span class="py">destination</span> <span class="p">=</span> <span class="s">"/var/www/html/manual"</span>
</code></pre></div></div>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>In this case, we are using a Git repository to download useful information on how to deal with the customized image. However, it is possible to download for instance code or other information that can be stored in Git. And what is most important, it is versioned.</p>


</div></div>
<p>Once edited, push the configuration to Image Builder and start the building process by selecting the blueprint and the output format. Builder Image tool can export the same blueprint into multiple output formats. Thus, one blueprint might create the same custom image running on multiple providers (qcow2 in our case).</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>composer-cli blueprints push devstation-centos8.toml

<span class="nv">$ </span>composer-cli compose start devstation-centos8 qcow2
Compose 248161f5-0870-41e8-b871-001348395ca7 added to the queue
</code></pre></div></div>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>It is possible to verify that the modified blueprint has been pushed successfully by executing the show command.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>composer-cli blueprints show devstation-centos8
</code></pre></div></div>


</div></div>
<p>The building process can take tens of minutes. It is possible to see the process by checking the lorax-composer logs in the journal or request the status of the blueprint built from the composer-cli:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>composer-cli compose status
248161f5-0870-41e8-b871-001348395ca7 RUNNING  Fri Nov 27 15:12:09 2020 devstation-centos8 0.0.2 qcow2

<span class="nv">$ </span>journalctl <span class="nt">-u</span> lorax-composer <span class="nt">-f</span>
Nov 27 15:13:31 eko3.cloud.lab.eng.bos.redhat.com lorax-composer[38218]: 2020-11-27 15:13:31,715: Installing.
Nov 27 15:13:31 eko3.cloud.lab.eng.bos.redhat.com lorax-composer[38218]: 2020-11-27 15:13:31,716: Starting package installation process
Nov 27 15:13:31 eko3.cloud.lab.eng.bos.redhat.com lorax-composer[38218]: 2020-11-27 15:13:31,716: Downloading packages
Nov 27 15:13:31 eko3.cloud.lab.eng.bos.redhat.com lorax-composer[38218]: 2020-11-27 15:13:31,716: Downloading 474 RPMs, 3.75 MiB / 396.83 MiB <span class="o">(</span>0%<span class="o">)</span> <span class="k">done</span><span class="nb">.</span>
Nov 27 15:13:31 eko3.cloud.lab.eng.bos.redhat.com lorax-composer[38218]: 2020-11-27 15:13:31,716: Downloading 474 RPMs, 15.58 MiB / 396.83 MiB <span class="o">(</span>3%<span class="o">)</span> <span class="k">done</span><span class="nb">.</span>
</code></pre></div></div>

<p>Once the building process is finished, it is time to download the <code class="language-plaintext highlighter-rouge">QCOW2</code> file. It can be downloaded from Cockpit UI or from the composer-cli:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>composer-cli compose image 248161f5-0870-41e8-b871-001348395ca7
248161f5-0870-41e8-b871-001348395ca7-disk.qcow2: 1854.31 MB

<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lhrt</span>
<span class="nt">-rw-r--r--</span><span class="nb">.</span>  1 root root 1.5K Nov 27 15:11 devstation-centos8.toml
<span class="nt">-rw-r--r--</span><span class="nb">.</span>  1 root root 1.9G Nov 27 15:26 248161f5-0870-41e8-b871-001348395ca7-disk.qcow2
</code></pre></div></div>

<p>Afterwards, the image is suggested to be renamed to something more meaningful. Below the information given by qemu is exhibited:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mv </span>248161f5-0870-41e8-b871-001348395ca7-disk.qcow2  golden-devstation-centos8-disk.qcow2

<span class="nv">$ </span>qemu-img info golden-devstation-centos8-disk.qcow2
image: golden-devstation-centos8-disk.qcow2
file format: qcow2
virtual size: 4.3G <span class="o">(</span>4566548480 bytes<span class="o">)</span>
disk size: 1.8G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: <span class="nb">false
    </span>refcount bits: 16
    corrupt: <span class="nb">false</span>
</code></pre></div></div>

<div class="premonition warning"><div class="fa fa-exclamation-circle"></div><div class="content"><p class="header">Warning</p><p>Virtual size of the image is 4.3G, since we agreed 10G the disk must be resized and root filesystem expanded before being containerized. Currently, there is no way to specify disk capacity in containerDisk as it can be done with <a href="https://github.com/kubevirt/kubevirt/blob/main/docs/container-empty-disks.md#implementation">emptyDisks</a>. The size of the root filesystem and disk when running in KubeVirt is driven by the image.
It is recommended to save the QCOW2 images under /var/lib/libvirt/images/ so that qemu user have permissions to expand or resize them.</p>


</div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>qemu-img resize golden-devstation-centos8-disk.qcow2 10G
Image resized.
</code></pre></div></div>

<p>The expansion is executed on the root partition, which in case of our golden image is <strong>/dev/sda2</strong> partition. It must be checked previously, for instance using the <em>virt-filesystems</em> utility:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>virt-filesystems <span class="nt">--partitions</span> <span class="nt">--long</span> <span class="nt">-a</span> golden-devstation-centos8-disk.qcow2
Name       Type       MBR  Size        Parent
/dev/sda1  partition  83   1073741824  /dev/sda
/dev/sda2  partition  83   2966421504  /dev/sda
</code></pre></div></div>

<p><br /></p>

<p>Note that a <strong>copy of the golden image</strong> is created and that’s the one expanded.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cp </span>golden-devstation-centos8-disk.qcow2 golden-devstation-centos8-disk-10G.qcow2
<span class="nv">$ </span>virt-resize <span class="nt">--expand</span> /dev/sda2  golden-devstation-centos8-disk.qcow2 golden-devstation-centos8-disk-10G.qcow2
<span class="o">[</span>   0.0] Examining golden-devstation-centos8-disk-10G.qcow2
<span class="k">**********</span>

Summary of changes:

/dev/sda1: This partition will be left alone.

/dev/sda2: This partition will be resized from 2.7G to 9.0G.  The
filesystem xfs on /dev/sda2 will be expanded using the ‘xfs_growfs’
method.

<span class="k">**********</span>
<span class="o">[</span>   2.2] Setting up initial partition table on golden-devstation-centos8-disk-10G.qcow2
<span class="o">[</span>   3.1] Copying /dev/sda1
<span class="o">[</span>   4.0] Copying /dev/sda2
 100%
<span class="o">[</span>   8.5] Expanding /dev/sda2 using the ‘xfs_growfs’ method

Resize operation completed with no errors.  Before deleting the old disk,
carefully check that the resized disk boots and works correctly.
</code></pre></div></div>

<p>Finally, it is verified that the image meets the expected size (see virtual size):</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>qemu-img info golden-devstation-centos8-disk-10G.qcow2
image: golden-devstation-centos8-disk-10G.qcow2
file format: qcow2
virtual size: 10G <span class="o">(</span>10737418240 bytes<span class="o">)</span>
disk size: 1.8G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: <span class="nb">false
    </span>refcount bits: 16
    corrupt: <span class="nb">false</span>
</code></pre></div></div>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>In case the developers are allowed to select between multiple flavours, e.g. different root filesystem sizes, you will end up with multiple containerized VM images. In the event that an additional block device is needed, <code class="language-plaintext highlighter-rouge">emptyDisk</code> is the proper way to go.</p>


</div></div>
<h3 id="verify-the-custom-built-image">Verify the custom-built image</h3>

<p>Before continuing, it is suggested to verify the golden expanded image. Since the qcow2 image is not yet containerized, it can easily run on KVM/libvirt. In our case, the builder server has already in place the <em>Virtualization Host</em> group packages.</p>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>There are a lot of tools that allow us to run a qcow2 image in libvirt. In this example, <code class="language-plaintext highlighter-rouge">virt-install</code> is used, however, other tool that makes easy to deploy VM images and worth exploring is <a href="https://github.com/karmab/kcli">kcli</a></p>


</div></div>
<p>First, install <a href="https://linux.die.net/man/1/virt-install">virt-install</a>, which is a command-line tool for creating new KVM, Xen, or Linux container guests using the “libvirt” hypervisor management library, and run a new VM from the golden image:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>yum <span class="nb">install </span>virt-install <span class="nt">-y</span>
<span class="nv">$ </span>virt-install <span class="nt">--version</span>
2.2.1

<span class="nv">$ </span>virt-install <span class="nt">--memory</span> 2048 <span class="nt">--vcpus</span> 2 <span class="nt">--name</span> devstation-centos8 <span class="nt">--disk</span> /var/lib/libvirt/images/golden-devstation-centos8-disk-10G.qcow2,device<span class="o">=</span>disk <span class="nt">--os-type</span> Linux <span class="nt">--os-variant</span> rhel8.1 <span class="nt">--virt-type</span> kvm <span class="nt">--graphics</span> none <span class="nt">--network</span> default <span class="nt">--import</span>

Starting install...
Connected to domain devstation-centos8
Escape character is ^]

CentOS Linux 8 <span class="o">(</span>Core<span class="o">)</span>
Kernel 4.18.0-147.5.1.el8_1.x86_64 on an x86_64
devstation login:
</code></pre></div></div>

<p>Login as <a href="#image-creation-with-builder-tool">developer or sysadmin user</a>, scale privileges and check that the VM is configured as expected.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>firewall-cmd <span class="nt">--list-all</span>
public <span class="o">(</span>active<span class="o">)</span>
  target: default
  icmp-block-inversion: no
  interfaces: ens3
  sources:
  services: cockpit dhcpv6-client http https mysql ssh
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl is-active httpd
active
<span class="nv">$ </span>systemctl is-active mariadb
active
<span class="nv">$ </span>systemctl is-active sshd
active
</code></pre></div></div>

<p>Verify the disk and partition sizes are correctly configured:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lsblk
NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda    252:0    0  10G  0 disk
├─vda1 252:1    0   1G  0 part /boot
└─vda2 252:2    0   9G  0 part /

<span class="nv">$ </span><span class="nb">df</span> <span class="nt">-h</span>
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        962M     0  962M   0% /dev
tmpfs           995M     0  995M   0% /dev/shm
tmpfs           995M   17M  979M   2% /run
tmpfs           995M     0  995M   0% /sys/fs/cgroup
/dev/vda2       9.0G  1.9G  7.2G  21% /
</code></pre></div></div>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>In case you are unsure on which partition you need to expand or contains the root filesystem, just run a VM from the golden qcow2 image and execute the previous commands. Then delete the VM and expand the image accordingly.</p>


</div></div>
<p>Finally, notice how the cloned repository has been copied successfully during the built process. Users can check the custom image information connecting to the local Apache server:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@devstation ~]# curl localhost/manual/
Dear developer,
&lt;br&gt;
&lt;br&gt;
Welcome to the devstation server.

&lt;h2&gt; How to use the devstation server &lt;/h2&gt;

Remember that before committing your changes to the corporate <span class="nb">source </span>management control server, you need to validate your code here.

&lt;h2&gt; Need <span class="nb">help</span>? &lt;/h2&gt;

Please contact us at sysadmin@corporate.com
</code></pre></div></div>

<p><br /></p>

<h3 id="image-tailoring-with-virt-customize">Image tailoring with virt-customize</h3>

<p>In the previous section, we verified that the golden image was successfully built. However, there are still a few things that need to be added so that the golden image can be successfully containerized and run on top of our OKD Kubernetes cluster.</p>

<p>First, a worthy package that is suggested to be included in the golden image is <a href="https://cloud-init.io/">cloud-init</a>. KubeVirt allows you to create VM objects along with <a href="https://kubevirt.io/user-guide/virtual_machines/startup_scripts/#cloud-init">cloud-init</a> configurations. Cloud-init will let our developers further adapt the custom image to their application needs. On the other hand, it has been agreed with the Software Engineering team to add a graphical interface to the custom image since there are developers that are not familiar with the terminal.</p>

<p>The result will be <strong>two golden images CentOS 8</strong>, both with cloud-init, but one will include a GUI and the other is terminal-based and therefore much lighter.</p>

<div class="premonition warning"><div class="fa fa-exclamation-circle"></div><div class="content"><p class="header">Warning</p><p>It is important to set the memsize of the building process to 4096m and have expanded the root filesystem otherwise you will face an out of space or/and out of memory error while installing the GNOME GUI.</p>


</div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>golden-devstation-centos8-disk-10G.qcow2 golden-devstation-centos8-disk-10G-gui.qcow2
virt-customize <span class="nt">--format</span> qcow2 <span class="nt">-a</span> /var/lib/libvirt/images/golden-devstation-centos8-disk-10G.qcow2 <span class="nt">--install</span> cloud-init <span class="nt">--memsize</span> 4096 <span class="nt">--selinux-relabel</span>
virt-customize <span class="nt">--format</span> qcow2 <span class="nt">-a</span> /var/lib/libvirt/images/golden-devstation-centos8-disk-10G-gui.qcow2 <span class="nt">--install</span> @graphical-server-environment,cloud-init <span class="nt">--memsize</span> 4096 <span class="nt">--run-command</span> <span class="s2">"systemctl set-default graphical.target"</span> <span class="nt">--selinux-relabel</span>
</code></pre></div></div>

<p><br /></p>

<p>At this point we built:</p>

<ul>
  <li>A golden CentOS 8 image which can run on libvirt/KVM virtualization servers (golden-devstation-centos8-disk.qcow2)</li>
  <li>A 10G CentOS 8 image prepared to be executed by KubeVirt including cloud-init. (golden-devstation-centos8-disk-10G.qcow2)</li>
  <li>A 10G CentOS 8 image prepared to be executed by KubeVirt including both cloud-init and GNOME GUI (golden-devstation-centos8-disk-10G-gui.qcow2)</li>
</ul>

<h2 id="building-a-standard-centos-7-image-from-cloud-images">Building a standard CentOS 7 image from cloud images</h2>

<p>In the previous section, it was shown how we can build and customize images from scratch using the Builder Image tool. However, there are settings that could not be configured even with the composer-cli. Thus, <em>virt-customize</em> is used to fine-tune the custom image, i.e, add cloud-init and a graphical user interface.</p>

<p>Since the Builder Tool is an <a href="https://docs.centos.org/en-US/centos/install-guide/Composer/">experimental tool in CentOS 7</a>, the company continues creating their golden CentOS 7 images based on CentOS cloud images. Comparing with the CentOS 8 workflow, the cloud image corresponds to the golden image even it is not built by the Systems Engineering department.</p>

<div class="premonition warning"><div class="fa fa-exclamation-circle"></div><div class="content"><p class="header">Warning</p><p>Note that with CentOS 7 images, the company is trusting a cloud image provided by a third party instead of creating one from scratch.</p>


</div></div>
<h3 id="image-creation-with-virt-customize">Image creation with virt-customize</h3>

<p>The process to create the golden CentOS 7 image is quite similar to the CentOS 8 one. However, in this case, the customize procedure is entirely done with <em>virt-customize</em>. The first step is to download the cloud image.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-o</span> /var/lib/libvirt/images/golden-devstation-centos7-disk.qcow2 https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2
</code></pre></div></div>

<p>Then, it is required to resize and expand the image to meet the agreed size of 10GB. The details are the same explained in the <a href="#image-creation-with-builder-tool">previous section</a></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>qemu-img info golden-devstation-centos7-disk.qcow2
image: golden-devstation-centos7-disk.qcow2
file format: qcow2
virtual size: 8.0G <span class="o">(</span>8589934592 bytes<span class="o">)</span>
disk size: 819M
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: <span class="nb">false
    </span>refcount bits: 16
    corrupt: <span class="nb">false</span>

<span class="nv">$ </span>qemu-img resize golden-devstation-centos7-disk.qcow2 10G
Image resized.

<span class="nv">$ </span><span class="nb">cp </span>golden-devstation-centos7-disk.qcow2 golden-devstation-centos7-disk-10G.qcow2
<span class="nv">$ </span>virt-resize <span class="nt">--expand</span> /dev/sda1  golden-devstation-centos7-disk.qcow2 golden-devstation-centos7-disk-10G.qcow2
</code></pre></div></div>

<div class="premonition warning"><div class="fa fa-exclamation-circle"></div><div class="content"><p class="header">Warning</p><p>In this case, unlike CentOS 8 image, the partition where the root filesystem resides is <strong>/dev/sda1</strong>. That’s the partition that needs to be expanded.</p>


</div></div>
<p>Below it is the <code class="language-plaintext highlighter-rouge">virt-customize</code> command that modifies the CentOS 7 <em>expanded</em> cloud image by:</p>

<ul>
  <li>Installing the required packages (however, not the exact versions)</li>
  <li>Changing the root password</li>
  <li>Setting devstation as hostname to the customized image</li>
  <li>Configuring the time zone</li>
  <li>Enabling the installed services</li>
  <li>Including files from the manual.</li>
</ul>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>Manual files must be pulled first from <a href="https://github.com/alosadagrande/lorax">alosadagrande/lorax</a> GitHub repository.</p>


</div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>virt-customize <span class="nt">--format</span> qcow2 <span class="nt">-a</span> /var/lib/libvirt/images/golden-devstation-centos7-disk-10G.qcow2 <span class="se">\</span>
                                <span class="nt">--install</span> cloud-init,mod_ssl,httpd,mariadb-server,php,openssh-server <span class="se">\</span>
                                <span class="nt">--memsize</span> 4096  <span class="nt">--hostname</span> devstation  <span class="nt">--selinux-relabel</span> <span class="nt">--timezone</span> Europe/Madrid <span class="se">\</span>
                                <span class="nt">--root-password</span> password:toor <span class="nt">--password</span> centos:password:developer123 <span class="se">\</span>
                                <span class="nt">--run-command</span> <span class="s1">'systemctl enable httpd'</span> <span class="nt">--run-command</span> <span class="s1">'systemctl enable mariadb'</span> <span class="se">\</span>
                                <span class="nt">--mkdir</span> /var/www/html/manual <span class="nt">--upload</span> ~/lorax/index.html:/var/www/html/manual/index.html
</code></pre></div></div>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>Instead of executing all parameters in the command-line it is possible to create a file that is used as an input file for <em>virt-customize</em>. See option <a href="http://libguestfs.org/virt-customize.1.html">commands-from-file</a></p>


</div></div>
<p>Next, we need to create the graphical user interface image in a similar way as we did previously with CentOS 8 image.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>golden-devstation-centos7-disk-10G.qcow2 golden-devstation-centos7-disk-10G-gui.qcow2

virt-customize <span class="nt">--format</span> qcow2 <span class="nt">-a</span> /var/lib/libvirt/images/golden-devstation-centos7-disk-10G-gui.qcow2 <span class="nt">--install</span> cloud-init <span class="nt">--memsize</span> 4096 <span class="nt">--run-command</span> <span class="s2">"yum groupinstall 'GNOME Desktop' -y"</span> <span class="nt">--run-command</span> <span class="s2">"systemctl set-default graphical.target"</span> <span class="nt">--selinux-relabel</span>
</code></pre></div></div>

<p>At this point we built:</p>

<ul>
  <li>A golden CentOS 7 image which can run on libvirt/KVM virtualization servers (golden-devstation-centos7-disk.qcow2).</li>
  <li>A 10G CentOS 7 image prepared to be executed by KubeVirt which includes cloud-init (golden-devstation-centos7-disk-10G.qcow2).</li>
  <li>A 10G CentOS 7 image prepared to be executed by KubeVirt which includes cloud-init and GNOME GUI (golden-devstation-centos7-disk-10G-gui.qcow2).</li>
</ul>

<h2 id="image-containerization-procedure">Image containerization procedure</h2>

<p>The procedure to inject a <em>VirtualMachineInstance</em> disk into a container images is pretty well explained in <a href="https://kubevirt.io/user-guide/virtual_machines/disks_and_volumes">containerDisk Workflow example</a> from the official documentation. Only RAW and QCOW2 formats are supported and the disk it is recommended to be placed into the /disk directory inside the container. Actually, it can be placed in other directories, but then, it must be explicitly configured when creating the <em>VirtualMachine</em></p>

<p>Currently, there are 4 standardized images ready to be containerized. The process is the same for all of them, so in order to keep it short, we are just going to show the process of creating a container image from the CentOS 8 QCOW2 images.</p>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>These are the four available images: CentOS 8 with GNOME, CentOS 8 terminal only, CentOS 7 with GNOME and CentOS 7 terminal only.</p>


</div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; Containerfile
FROM scratch
ADD golden-devstation-centos8-disk-10G.qcow2 /disk/
</span><span class="no">EOF
</span></code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>Containerfile
FROM scratch
ADD golden-devstation-centos8-disk-10G-gui.qcow2 /disk/
</code></pre></div></div>

<p>Then, it is time to build the image. In our case, <a href="https://podman.io/">podman</a> has chosen to execute the task, however, we could have used <code class="language-plaintext highlighter-rouge">docker</code> or <code class="language-plaintext highlighter-rouge">buildah</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>podman build <span class="nb">.</span> <span class="nt">-t</span> openshift/devstation-centos8:terminal
STEP 1: FROM scratch
STEP 2: ADD golden-devstation-centos8-disk-10G.qcow2 /disk/
STEP 3: COMMIT openshift/devstation-centos8:terminal
8a9e83db71f08995fa73699c4e5a2d331c61b393daa18aa0b63269dc10078467

<span class="nv">$ </span>podman build <span class="nb">.</span> <span class="nt">-t</span> openshift/devstation-centos8:gui
STEP 1: FROM scratch
STEP 2: ADD golden-devstation-centos8-disk-10G-gui.qcow2 /disk/
STEP 3: COMMIT openshift/devstation-centos8:gui
2a4ecc7bf9da91bcb5847fd1cf46f4cd10726a4ceae88815eb2a9ab38b316be4
</code></pre></div></div>

<p>After the successful build, the images are stored locally to the local server, in our case the Builder Server. Remember that they must be uploaded to the OKD container registry.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>podman images
REPOSITORY                               TAG        IMAGE ID       CREATED          SIZE
localhost/openshift/devstation-centos8   gui        2a4ecc7bf9da   3 minutes ago    5.72 GB
localhost/openshift/devstation-centos8   terminal   8a9e83db71f0   13 minutes ago   1.94 GB
</code></pre></div></div>

<h3 id="store-the-image-in-the-container-registry">Store the image in the container registry</h3>

<p>Before pushing the images to the corporate container registry, it must be verified that the OKD registry is available outside the Kubernetes cluster. This allows any authenticated user to gain external access to push images into the OKD Kubernetes cluster. <a href="https://docs.openshift.com/container-platform/4.3/registry/securing-exposing-registry.html">Exposing the secure registry</a> consists basically on configuring a route and expose that route in the OKD routers. Once done, external <strong>authenticated</strong> access is allowed.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc get route <span class="nt">-n</span> openshift-image-registry
NAME            HOST/PORT                                                     PATH   SERVICES         PORT    TERMINATION   WILDCARD
default-route   default-route-openshift-image-registry.apps.okd.okdlabs.com          image-registry   &lt;all&gt;   reencrypt     None
</code></pre></div></div>

<div class="premonition note"><div class="fa fa-check-square"></div><div class="content"><p class="header">Note</p><p>In order to upload your containerized images to the OKD registry, the user must be authenticated and <a href="https://docs.openshift.com/container-platform/4.3/registry/accessing-the-registry.html">authorized to execute the push action</a>. The role that must be added to the OKD user is the <em>registry-editor</em></p>


</div></div>
<p>In order to authenticate with the OKD container registry, podman is employed as explained in the <a href="https://docs.openshift.com/container-platform/4.3/registry/securing-exposing-registry.html">official documentation</a>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc login https://api.okd.okdlabs.com:6443 <span class="nt">-u</span> alosadag
The server uses a certificate signed by an unknown authority.
You can bypass the certificate check, but any data you send to the server could be intercepted by others.
Use insecure connections? <span class="o">(</span>y/n<span class="o">)</span>: y

Authentication required <span class="k">for </span>https://api.okd.okdlabs.com:6443 <span class="o">(</span>openshift<span class="o">)</span>
Username: alosadag
Password:
Login successful.

<span class="nv">$ HOST</span><span class="o">=</span><span class="si">$(</span>oc get route default-route <span class="nt">-n</span> openshift-image-registry <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.spec.host }'</span><span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$HOST</span>
default-route-openshift-image-registry.apps.okd.okdlabs.com

<span class="nv">$ </span> podman login <span class="nt">-u</span> <span class="si">$(</span>oc <span class="nb">whoami</span><span class="si">)</span> <span class="nt">-p</span> <span class="si">$(</span>oc <span class="nb">whoami</span> <span class="nt">-t</span><span class="si">)</span> <span class="nt">--tls-verify</span><span class="o">=</span><span class="nb">false</span> <span class="nv">$HOST</span>
Login Succeeded!
</code></pre></div></div>

<p>Before pushing the images, adapt container images to the proper name so they can be uploaded to private registries. Since it is agreed that all developers must be able to pull the images into their namespaces, the images need to be pushed to the openshift project.</p>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p><a href="https://docs.openshift.com/container-platform/4.6/openshift_images/images-understand.html">Understanding containers, images and imageStreams</a> from OpenShift documentation deeply explains container image naming.</p>


</div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podman tag localhost/openshift/devstation-centos8:gui default-route-openshift-image-registry.apps.okd.okdlabs.com/openshift/devstation:v8-terminal
podman push default-route-openshift-image-registry.apps.okd.okdlabs.com/openshift/devstation:v8-terminal <span class="nt">--tls-verify</span><span class="o">=</span><span class="nb">false</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podman tag localhost/openshift/devstation-centos:gui default-route-openshift-image-registry.apps.okd.okdlabs.com/openshift/devstation:v8-gui
podman push default-route-openshift-image-registry.apps.okd.okdlabs.com/openshift/devstation:v8-gui <span class="nt">--tls-verify</span><span class="o">=</span><span class="nb">false</span>
</code></pre></div></div>

<p>Verify that the images are stored correctly in the OKD container registry by checking the <a href="https://docs.openshift.com/container-platform/4.6/openshift_images/image-streams-manage.html#working-with-imagestreams">imageStream</a>. As shown below, both images were uploaded successfully since the <code class="language-plaintext highlighter-rouge">devstation</code> imageStream contains two images with v8-gui and v8-terminal tags respectively.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc describe imageStream devstation <span class="nt">-n</span> openshift
Name:                   devstation
Namespace:              openshift
Created:                23 hours ago
Labels:                 &lt;none&gt;
Annotations:            &lt;none&gt;
Image Repository:       default-route-openshift-image-registry.apps.okd.okdlabs.com/openshift/devstation
Image Lookup:           <span class="nb">local</span><span class="o">=</span><span class="nb">false
</span>Unique Images:          2
Tags:                   2

v8-gui
  no spec tag

  <span class="k">*</span> image-registry.openshift-image-registry.svc:5000/openshift/devstation@sha256:e301d935c1cb5a64d41df340d78e6162ddb0ede9b9b5df9c20df10d78f8fde0f
      2 hours ago

v8-terminal
  no spec tag

  <span class="k">*</span> image-registry.openshift-image-registry.svc:5000/openshift/devstation@sha256:47c2ba0c463da84fa1569b7fb8552c07167f3464a9ce3b6e3f607207ba4cee65
</code></pre></div></div>

<p>At this point, the images are stored in a private registry and ready to be consumed by the developers.</p>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>In case you do not have a corporate private registry available, you can upload images to any free public container registry. Then, consume the container images from the public container registry. Just in case you want to use them or take a look, it has been uploaded to my <a href="https://quay.io/repository/alosadag/devstation?tab=tags">public container image repository at quay.io</a></p>


</div></div>
<div class="my-gallery" itemscope="" itemtype="http://schema.org/ImageGallery">
  <figure itemprop="associatedMedia" itemscope="" itemtype="http://schema.org/ImageObject">
    <a href="/assets/2020-12-01-Customizing-images-for-containerized-vms/okd_is_devstation.png" itemprop="contentUrl" data-size="1110x467">
      <img src="/assets/2020-12-01-Customizing-images-for-containerized-vms/okd_is_devstation.png" itemprop="thumbnail" width="100%" alt="VM to VM" />
    </a>
    <figcaption itemprop="caption description"></figcaption>
  </figure>
</div>

<p>In the next article, we will show how our developers can consume the custom-built images to run into the OKD Kubernetes cluster.</p>

<h2 id="summary">Summary</h2>

<p>In this blog post, it was detailed a real use of a company that uses KubeVirt to run standardized environments to run and test the code of their applications. In their use case, VMs are spinned up on-demand in the OKD Kubernetes cluster by the developers. This makes them completely autonomous creating and deleting their environments once the tasks are accomplished.</p>

<p>The article explained how to create a golden image using different tools such as Builder Tool and virt-customize. Once the custom-built image was ready, then it is transformed into a container image so that it can be uploaded and stored into a container registry.</p>

<div class="premonition info"><div class="fa fa-info-circle"></div><div class="content"><p class="header">Information</p><p>In the next blog post, the custom-built containerized VM will be deployed from our corporate registry into our Kubernetes cluster. We will show how the developers can fine-tune even more the image deployment, how extra storage can be requested and how to connect to the <code class="language-plaintext highlighter-rouge">VirtualMachineInstance</code>. Stay tuned!</p>


</div></div>
<h2 id="references">References</h2>

<ul>
  <li><a href="https://kubevirt.io/pages/cloud.html">KubeVirt installation</a></li>
  <li><a href="https://developers.redhat.com/blog/2019/05/08/red-hat-enterprise-linux-8-image-builder-building-custom-system-images/">Image Builder: Building custom system images</a></li>
  <li><a href="https://weldr.io/lorax/composer-cli.html">Composer-cli information</a></li>
  <li><a href="https://quay.io/repository/alosadag/devstation?tab=tags">Custom-built images available at quay.io</a></li>
</ul>

        </article>
        
        

<a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=Customizing images for containerized VMs part I&url=https://www.kubevirt.io/2020/Customizing-images-for-containerized-vms.html&screen_name=kubevirt" aria-label="Share this on Twitter">
  <i class="fab fa-twitter mr-1"></i> Tweet
</a>
<hr/>


      </div>
    </div>
  </div>
</div>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script src="/js/photoswipe-page.js">
</script>

    </main>

    <footer class="footer" role="footer">
      <div class="container-fluid">
  <div class="row justify-content-between">
    <div class="col-sm-12 col-md-5">
      <p>We are a <a href="https://cncf.io/">Cloud Native Computing Foundation</a> sandbox project.</p>
      <p><a href="https://cncf.io/"><img src="/assets/images/cncf-color.png" alt="Cloud Native Computing Foundation"/></a></p>
    </div>
    <div class="col-sm-12 col-md-5" style="text-align: center;">
      <p class="text-md-right">

        <a href="https://twitter.com/kubevirt" data-toggle="tooltip" data-placement="top" title="Follow us on Twitter!" aria-label="Visit us on Twitter" class="link-social-twitter">
          <i class="fab fa-twitter fa-lg"></i>
        </a>

        <a href="https://kubernetes.slack.com/archives/C8ED7RKFE" data-toggle="tooltip" data-placement="top" title="Join our Slack channel!" class="link-social-slack">
          <i class="fab fa-slack fa-lg"></i>
        </a>

        <a href="https://github.com/kubevirt" data-toggle="tooltip" data-placement="top" title="Check our GitHub!" class="link-social-github">
          <i class="fab fa-github fa-lg"></i>
        </a>

        <a href="https://groups.google.com/forum/#!forum/kubevirt-dev" data-toggle="tooltip" data-placement="top" title="Join our mailing list!" class="link-social-mail">
          <i class="fas fa-envelope fa-lg"></i>
        </a>

        <a href="https://calendar.google.com/calendar/u/0/embed?src=kubevirt@cncf.io" data-toggle="tooltip" data-placement="top" title="See our events calendar!" class="link-social-calendar">
          <i class="fas fa-calendar fa-lg"></i>
        </a>

        <a href="https://www.youtube.com/channel/UC2FH36TbZizw25pVT1P3C3g/videos" data-toggle="tooltip" data-placement="top" title="Subscribe to our YouTube channel!" class="link-social-youtube">
          <i class="fab fa-youtube fa-lg"></i>
        </a>

      </p>
    </div>
  </div>
  <div class="row">
    <div class="col text-sm-left footer-licensing" style="text-align: center;">
      Copyright 2022 The KubeVirt Contributors<br>
      Copyright 2022 The Linux Foundation. All Rights Reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage</a> page.<br>
      This site is powered by <a href="https://www.netlify.com/legal/open-source-policy/">Netlify</a>.
      <p class="privacy-statement text-sm-left" style="text-align: center;">
        <a href="/privacy" class="privacy-statement-link">Privacy Statement</a>
      </p>
  </div>
</div>
<script src="/js/copy.js"></script>

    </footer>

    <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js" integrity="sha384-3LK/3kTpDE/Pkp8gTNp2gR/2gOiwQ6QaO7Td0zV76UFJVhqLl4Vl3KL1We6q6wR9" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <script src="/js/kubevirt-io.js"></script>
    <!-- Photoswipe -->
    <!-- Core JS file -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.js"></script>
    <!-- UI JS file -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

    <!-- This comes from DTM/DPAL and must be latest entry in body-->

    <script type="text/javascript">
        if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
            _satellite.pageBottom();
        }
    </script>
  </body>
</html>
